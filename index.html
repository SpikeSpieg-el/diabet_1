<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дневник диабетика</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-slate-900 dark:to-slate-800 transition-colors duration-300">
    <div id="app" class="container mx-auto p-4 max-w-7xl">
        <!-- Заголовок -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 dark:bg-slate-800">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-2">Дневник</h1>
                    <p class="text-gray-600 dark:text-gray-300">Управление питанием, контроль глюкозы и расчет дозы инсулина</p>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="showAiSettingsModalBtn" title="Настройки ИИ-помощника" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
                        <i data-lucide="brain-circuit" class="w-6 h-6 text-purple-500 dark:text-purple-400"></i>
                    </button>
                    <button id="darkModeToggle" title="Переключить тему" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
                        {/* Icon will be set by JavaScript */}
                    </button>
                </div>
            </div>
        </div>

        <!-- Навигация -->
        <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-800 shadow-lg border-t border-gray-200 dark:border-slate-700 z-50">
            <div id="navigation-buttons" class="flex justify-around items-center max-w-7xl mx-auto px-2 py-2">
                <button data-view="calendar" class="nav-button flex flex-col items-center px-3 py-2 rounded-lg transition-colors">
                    <i data-lucide="calendar" class="w-6 h-6 mb-1"></i>
                    <span class="text-xs">Календарь</span>
                </button>
                <button data-view="analytics" class="nav-button flex flex-col items-center px-3 py-2 rounded-lg transition-colors">
                    <i data-lucide="trending-up" class="w-6 h-6 mb-1"></i>
                    <span class="text-xs">Аналитика</span>
                </button>
                <button data-view="reports" class="nav-button flex flex-col items-center px-3 py-2 rounded-lg transition-colors">
                    <i data-lucide="bar-chart-3" class="w-6 h-6 mb-1"></i>
                    <span class="text-xs">Отчеты</span>
                </button>
                <button data-view="products" class="nav-button flex flex-col items-center px-3 py-2 rounded-lg transition-colors">
                    <i data-lucide="database" class="w-6 h-6 mb-1"></i>
                    <span class="text-xs">Продукты</span>
                </button>
                <button data-view="calculator" class="nav-button flex flex-col items-center px-3 py-2 rounded-lg transition-colors">
                    <i data-lucide="calculator" class="w-6 h-6 mb-1"></i>
                    <span class="text-xs">Калькулятор</span>
                </button>
            </div>
        </div>

        <!-- Добавляем отступ снизу для контента -->
        <div class="pb-20">
        <!-- Календарь View -->
        <div id="calendarView" class="view-content grid grid-cols-1 xl:grid-cols-3 gap-6">
            <!-- Календарная сетка (takes 1/3 width on XL) -->
            <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                <div class="flex justify-between items-center mb-4">
                    <button id="prevMonthBtn" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors" style="color: aliceblue;">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    </button>
                    <h2 id="calendarHeader" class="text-xl font-semibold text-gray-800 dark:text-gray-100"></h2>
                    <button id="nextMonthBtn" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors" style="color: aliceblue;">
                         <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="grid grid-cols-7 gap-2 mb-4">
                    <!-- Дни недели -->
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-2">
                    <!-- Дни -->
                </div>
                 <!-- Export/Import Buttons -->
                 <div class="mt-6 flex space-x-2 justify-center calendar-actions">
                    <button id="todayBtn" class="bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg hover:bg-gray-300 dark:bg-slate-600 dark:text-gray-200 dark:hover:bg-slate-500 transition-colors flex items-center text-xs sm:text-sm">
                        <i data-lucide="calendar" class="w-4 h-4 mr-1.5"></i> Сегодня
                    </button>
                    <button id="exportDayDataBtn" class="bg-purple-500 text-white px-3 py-1.5 rounded-lg hover:bg-purple-600 dark:bg-purple-600 dark:hover:bg-purple-700 transition-colors flex items-center text-xs sm:text-sm" style="margin: 0;">
                        <i data-lucide="download" class="w-4 h-4 mr-1.5"></i> Экспорт дня 
                    </button>
                    <button id="importDataBtn" class="bg-teal-500 text-white px-3 py-1.5 rounded-lg hover:bg-teal-600 dark:bg-teal-600 dark:hover:bg-teal-700 transition-colors flex items-center text-xs sm:text-sm" style="margin: 0;">
                        <i data-lucide="upload" class="w-4 h-4 mr-1.5"></i> Импорт
                    </button>
                    <button id="exportAllDataBtn" class="bg-orange-500 text-white px-3 py-1.5 rounded-lg hover:bg-orange-600 dark:bg-orange-600 dark:hover:bg-orange-700 transition-colors flex items-center text-xs sm:text-sm" style="margin: 0;">
                        <i data-lucide="archive" class="w-4 h-4 mr-1.5"></i> Экспорт всех
                    </button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display: none;">
            </div>

            <!-- Правая колонка -->
            <div class="xl:col-span-2 space-y-6"> 
                <!-- Predicted Sugar Section (ОБНОВЛЕНО) -->
                <div id="predictedSugarSection" class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800" style="display: none;">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-semibold dark:text-gray-100">Прогноз сахара</h2>
                        <button id="correctPredictionBtn" class="bg-green-500 text-white px-3 py-1.5 rounded-lg hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 transition-colors flex items-center text-sm">
                            <i data-lucide="edit-3" class="w-4 h-4 mr-1.5"></i> Внести измерение
                        </button>
                    </div>
                    
                    <!-- Локальный прогноз -->
                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Локальный расчет (мгновенно)</h3>
                    <div id="predictedSugarDisplay" class="text-3xl font-bold mb-1">
                        {/* Prediction will be shown here */}
                    </div>
                    <div id="predictionContextEl" class="text-xs text-gray-500 dark:text-gray-400 space-y-1 mb-4">
                        <span id="pc_status" class="block error-message"></span>
                        <span id="pc_baseline" class="block"></span>
                        <span id="pc_carbs" class="block"></span>
                        <span id="pc_insulin" class="block"></span>
                        <span id="pc_iob" class="block"></span>
                    </div>

                    <hr class="dark:border-slate-700 my-4">

                    <!-- Прогноз от ИИ (НОВЫЙ БЛОК) -->
                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Прогноз от ИИ-помощника (на 2 часа)</h3>
                    <div id="aiPredictionResultContainer" class="space-y-3">
                        <button id="requestAiPredictionBtn" class="w-full bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 dark:bg-purple-600 dark:hover:bg-purple-700 transition-colors flex items-center justify-center">
                            <i data-lucide="brain-circuit" class="w-5 h-5 mr-2"></i> Запросить прогноз у ИИ
                        </button>
                        <div id="aiPredictionResultText" class="p-3 bg-purple-50 rounded-lg dark:bg-slate-700 dark:text-gray-300 text-sm" style="display: none;">
                            <!-- Результат от ИИ будет здесь -->
                        </div>
                        <p class="text-xs text-gray-400 text-center">Прогноз от ИИ является оценочным и не заменяет измерение глюкометром.</p>
                    </div>
                </div>
                
                

                <!-- Приемы пищи за день -->
                <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="mealsHeader" class="text-xl font-semibold dark:text-gray-100">Питание</h2>
                        <button id="showAddMealModalBtn" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 transition-colors">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="dayMealsContainer" class="space-y-4 max-h-96 overflow-y-auto">
                        {/* Записи о приемах пищи */}
                    </div>
                </div>

                <!-- Уровень глюкозы за день -->
                <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="glucoseHeader" class="text-xl font-semibold dark:text-gray-100">Глюкоза</h2>
                        <button id="showAddGlucoseModalBtn" class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-700 transition-colors">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="dayGlucoseContainer" class="space-y-3 max-h-96 overflow-y-auto">
                        {/* Записи глюкозы */}
                    </div>
                    <div id="dayGlucoseChartContainer" class="mt-6" style="display: none;">
                        <h3 class="text-sm font-medium mb-2 dark:text-gray-300">График за день</h3>
                        <div class="chart-container h-32">
                            <canvas id="dayGlucoseChartCanvas"></canvas>
                        </div>
                    </div>
                    
                </div>
                <!-- Дневная сводка -->
                <div id="daySummaryContainer" class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                    <h2 class="text-xl font-semibold mb-4 dark:text-gray-100">Сводка за день</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 rounded-lg p-4 dark:bg-slate-700">
                            <div id="dayTotalCarbs" class="text-2xl font-bold text-blue-600 dark:text-blue-400">0г</div>
                            <div class="text-sm text-blue-600 dark:text-blue-400">Углеводы</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 dark:bg-slate-700">
                            <div id="dayTotalInsulin" class="text-2xl font-bold text-green-600 dark:text-green-400">0 ед</div>
                            <div class="text-sm text-green-600 dark:text-green-400">Инсулин</div>
                        </div>
                        <div class="bg-red-50 rounded-lg p-4 dark:bg-slate-700">
                            <div id="dayAvgGlucose" class="text-2xl font-bold text-red-600 dark:text-red-400">0</div>
                            <div class="text-sm text-red-600 dark:text-red-400">Средняя глюкоза</div>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-4 dark:bg-slate-700">
                            <div id="dayMealsCount" class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">0</div>
                            <div class="text-sm text-yellow-600 dark:text-yellow-400">Приемов пищи</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Аналитика View -->
        <div id="analyticsView" class="view-content space-y-8" style="display: none;">
            <!-- Недельная аналитика -->
            <div class="space-y-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Аналитика за неделю</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-100">Средний уровень глюкозы</h3>
                        <div class="chart-container h-64">
                            <canvas id="weekGlucoseChartCanvas"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-100">Углеводы и инсулин</h3>
                        <div class="chart-container h-64">
                            <canvas id="carbsInsulinChartCanvas"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-100">Активность</h3>
                        <div class="chart-container h-64">
                            <canvas id="activityChartCanvas"></canvas>
                        </div>
                    </div>
                    <div id="weekSummaryContainer" class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-100">Сводка</h3>
                        <!-- Сводка будет вставлена сюда -->
                    </div>
                </div>
            </div>

            <!-- Месячная аналитика -->
            <div class="space-y-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Аналитика за месяц</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-100">Средний уровень глюкозы</h3>
                        <div class="chart-container h-64">
                            <canvas id="monthGlucoseChartCanvas"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-100">Углеводы и инсулин</h3>
                        <div class="chart-container h-64">
                            <canvas id="monthCarbsInsulinChartCanvas"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-100">Активность</h3>
                        <div class="chart-container h-64">
                            <canvas id="monthActivityChartCanvas"></canvas>
                        </div>
                    </div>
                    <div id="monthSummaryContainer" class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-100">Сводка</h3>
                        <!-- Сводка будет вставлена сюда -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Отчеты View -->
        <div id="reportsView" class="view-content space-y-6" style="display: none;">
            <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                <h2 class="text-xl font-semibold mb-4 dark:text-gray-100">Детальный отчет за неделю</h2>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead class="dark:text-gray-200">
                            <tr class="bg-gray-50 dark:bg-slate-700">
                                <th class="border p-3 text-left dark:border-slate-600">Дата</th>
                                <th class="border p-3 text-left dark:border-slate-600">Приемы пищи</th>
                                <th class="border p-3 text-left dark:border-slate-600">Углеводы (г)</th>
                                <th class="border p-3 text-left dark:border-slate-600">Инсулин (ед)</th>
                                <th class="border p-3 text-left dark:border-slate-600">Ср. глюкоза</th>
                                <th class="border p-3 text-left dark:border-slate-600">Измерения</th>
                            </tr>
                        </thead>
                        <tbody id="weekReportTableBody" class="dark:text-gray-300 dark:border-slate-600">
                            <!-- Данные отчета -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div id="glucoseControlAnalysisContainer" class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                    <h3 class="text-lg font-semibold mb-4 dark:text-gray-100">Анализ контроля глюкозы</h3>
                    <!-- Анализ будет вставлен сюда -->
                </div>
                <div id="recommendationsContainer" class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                    <h3 class="text-lg font-semibold mb-4 dark:text-gray-100">Рекомендации</h3>
                    <!-- Рекомендации -->
                </div>
            </div>
        </div>

        <!-- Продукты View -->
        <div id="productsView" class="view-content bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold dark:text-gray-100">Реестр продуктов</h2>
                <button id="showAddProductModalBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 transition-colors flex items-center">
                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Добавить продукт
                </button>
            </div>
            <div class="overflow-x-auto">
                <!-- Изменяем таблицу на div для мобильной версии -->
                <div id="productsTableBody" class="w-full"></div>
            </div>
        </div>

        <!-- Калькулятор View -->
        <div id="calculatorView" class="view-content" style="display: none;">
            <div id="calculatorHost">
                <div class="container"> <!-- This is the calculator's .container -->
                    <h1>Персональный калькулятор сахара (Адаптивный)</h1>
            
                    <div class="settings-section">
                        <h3>Ваши индивидуальные коэффициенты <span class="info-tooltip-icon" onclick="showPopup('settingsInfo')">?</span></h3>
                        <p class="info-tooltip" style="font-size: 0.85em; color: #5a6268;">Значения должны быть согласованы с вашим врачом.</p>
                        
                        <label for="settingCarbRatio">Углеводный коэффициент (УК) <span class="info-tooltip-icon" onclick="showPopup('carbRatioInfo')">?</span></label>
                        <input type="number" id="settingCarbRatio" step="0.1">
                        <div class="error-message" id="settingCarbRatioError"></div>
            
                        <label for="settingSensitivityFactor">Фактор чувствительности к инсулину (ФЧИ) <span class="info-tooltip-icon" onclick="showPopup('sensitivityFactorInfo')">?</span></label>
                        <input type="number" id="settingSensitivityFactor" step="0.1">
                        <div class="error-message" id="settingSensitivityFactorError"></div>
            
                        <label for="settingTargetSugar">Целевой уровень сахара <span class="info-tooltip-icon" onclick="showPopup('targetSugarInfo')">?</span></label>
                        <input type="number" id="settingTargetSugar" step="0.1">
                        <div class="error-message" id="settingTargetSugarError"></div>
            
                        <button type="button" class="save-settings" onclick="saveSettings()">Сохранить мои коэффициенты</button>
                    </div>
            
                    <h2>Расчет прогноза (на ~2 часа после еды):</h2>
                    <strong>Используемые коэффициенты:</strong><br>
                    <form id="diabetesForm">
                        <div class="calc-coeffs-display">
                            
                            <label for="calcCarbRatio">УК: <input type="number" id="calcCarbRatio" step="0.1" readonly></label>
                            <label for="calcSensitivityFactor">ФЧИ: <input type="number" id="calcSensitivityFactor" step="0.1" readonly></label>
                            <label for="calcTargetSugar">Цель: <input type="number" id="calcTargetSugar" step="0.1" readonly></label>
                        </div>
            
                        <label for="currentSugar">1. Текущий уровень сахара (ммоль/л) <span class="info-tooltip-icon" onclick="showPopup('currentSugarInfo')">?</span></label>
                        <input type="number" id="currentSugar" name="currentSugar" step="0.1" required>
                        <div class="error-message" id="currentSugarError"></div>
            
                        <label for="carbs">2. Количество углеводов в пище (граммы) <span class="info-tooltip-icon" onclick="showPopup('carbsInfo')">?</span></label>
                        <input type="number" id="carbs" name="carbs" step="1" required>
                        <div class="error-message" id="carbsError"></div>
            
                        <label for="mealType">3. Тип пищи <span class="info-tooltip-icon" onclick="showPopup('mealTypeInfo')">?</span></label>
                        <select id="mealType" name="mealType">
                            <option value="balanced" selected>Сбалансированная еда (стандарт)</option>
                            <option value="fast">Преимущественно быстрые углеводы</option>
                            <option value="slow">Медленные углеводы / Жирная/белковая пища</option>
                        </select>
            
                        <label for="activityLevel">4. Физическая активность <span class="info-tooltip-icon" onclick="showPopup('activityLevelInfo')">?</span></label>
                        <select id="activityLevel" name="activityLevel">
                            <option value="none" selected>Без значительной активности</option>
                            <option value="light">Легкая (прогулка)</option>
                            <option value="moderate">Умеренная/Интенсивная</option>
                        </select>
                        
                        <label for="insulinDose">5. Введенная доза инсулина (ед.) <span class="info-tooltip-icon" onclick="showPopup('insulinDoseInfo')">?</span></label>
                        <input type="number" id="insulinDose" name="insulinDose" step="0.1" required>
                        <div class="error-message" id="insulinDoseError"></div>
            
                        <button type="button" onclick="calculatePrediction()">Рассчитать прогноз</button>
                    </form>
            
                    <div class="result-section" id="predictionArea" style="display:none;">
                         <h2>Результаты расчета:</h2>
                        <p>Расчетная доза инсулина на еду (РД<sub>еда</sub>): <strong id="foodDoseResult">--</strong> ед.</p>
                        <p>Расчетная доза инсулина на коррекцию (РД<sub>корр</sub>): <strong id="correctionDoseResult">--</strong> ед.</p>
                        <p><strong>Общая расчетная потребность в инсулине (ОРПИ):</strong> <strong id="totalCalculatedDoseResult">--</strong> ед.</p>
                        <hr>
                        <p>Вы ввели: <strong id="enteredDoseDisplay">--</strong> ед. инсулина.</p>
                        <p>Разница (Введенная доза - ОРПИ): <strong id="doseDifferenceResult">--</strong> ед.</p>
                        <hr>
                        <p><strong>Приблизительный прогнозируемый уровень сахара через ~2 часа:</strong> <br><strong id="predictedSugarResult">--</strong> ммоль/л</p>
                        <p id="additionalComments" style="font-style: italic; margin-top:15px;"></p>
                    </div>
                     
                </div>
            
                <!-- Popup Overlay and Content for Calculator -->
                <div class="popup-overlay" id="popupOverlay" onclick="closePopupOnClickOutside(event)">
                    <div class="popup-content" id="popupContentContainer">
                        
                        <h4 id="popupTitle">Заголовок подсказки</h4>
                        <div id="popupText">Текст подсказки здесь...</div>
                        <button class="popup-close-btn" onclick="hidePopup()">&times;</button>
                    </div>
                    
                </div>
            </div>
        </div>


        <!-- Модальное окно добавления/редактирования продукта -->
        <div id="addProductModal" class="modal fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-md dark:bg-slate-800">
                <h3 id="addProductModalTitle" class="text-lg font-semibold mb-4 dark:text-gray-100">Добавить продукт</h3>
                <form id="addProductForm" class="space-y-4">
                    <input type="hidden" id="editingProductId">
                    <input type="text" id="newProductName" placeholder="Название продукта" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400" required>
                    <input type="number" id="newProductCarbs" placeholder="Углеводы (г на 100г продукта)" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400" required step="0.1">
                    <input type="number" id="newProductInsulinRatio" placeholder="Инсулин (единиц на 1 ХЕ)" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400" required step="0.1">
                    <div class="flex space-x-3">
                        <button type="submit" id="addProductSubmitBtn" class="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 transition-colors">Добавить</button>
                        <button type="button" id="cancelAddProductBtn" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 dark:bg-slate-600 dark:text-gray-200 dark:hover:bg-slate-500 transition-colors">Отмена</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Модальное окно добавления приема пищи -->
        <div id="addMealModal" class="modal fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto dark:bg-slate-800">
                <h3 class="text-lg font-semibold mb-4 dark:text-gray-100">Добавить прием пищи</h3>
                <form id="addMealForm" class="space-y-4">
                    <input type="time" id="newMealTime" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:[color-scheme:dark]" required>
                    <div class="border rounded-lg p-4 dark:border-slate-700">
                        <h4 class="font-medium mb-3 dark:text-gray-200">Добавить продукт:</h4>
                        <div class="flex flex-col sm:flex-row gap-2 mb-3">
                            <select id="newMealSelectedProduct" class="flex-1 p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50">
                                <option value="">Выберите продукт</option>
                                <!-- Опции продуктов -->
                            </select>
                            <div class="flex gap-2">
                                <input type="number" id="newMealProductAmount" placeholder="Вес (г)" class="w-full sm:w-24 p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400" step="1" min="1">
                                <button type="button" id="addProductToMealBtn" class="px-3 py-2 rounded-lg bg-green-500 text-white hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 transition-colors whitespace-nowrap">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="newMealProductsListContainer" class="border rounded-lg p-4 dark:border-slate-700" style="display:none;">
                        <h4 class="font-medium mb-3 dark:text-gray-200">Выбранные продукты:</h4>
                        <div id="newMealProductsList" class="space-y-2">
                            <!-- Список добавленных продуктов -->
                        </div>
                        <div id="newMealCalculation" class="mt-3 p-3 bg-blue-50 rounded dark:bg-slate-700 dark:text-gray-300" style="display:none;">
                            <!-- Расчеты -->
                        </div>
                    </div>
                    <input type="number" id="newMealActualInsulin" step="0.1" placeholder="Фактически введено инсулина (единиц)" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400">
                    <textarea id="newMealNotes" placeholder="Заметки (необязательно)" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400" rows="2"></textarea>
                    <div class="flex space-x-3">
                        <button type="submit" id="addMealSubmitBtn" class="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 transition-colors">Добавить прием пищи</button>
                        <button type="button" id="cancelAddMealBtn" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 dark:bg-slate-600 dark:text-gray-200 dark:hover:bg-slate-500 transition-colors">Отмена</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Модальное окно добавления измерения глюкозы -->
        <div id="addGlucoseModal" class="modal fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-md dark:bg-slate-800">
                <h3 class="text-lg font-semibold mb-4 dark:text-gray-100">Добавить измерение глюкозы</h3>
                <form id="addGlucoseForm" class="space-y-4">
                    <input type="time" id="newGlucoseTime" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:[color-scheme:dark]" required>
                    <input type="number" id="newGlucoseLevel" step="0.1" placeholder="Уровень глюкозы (ммоль/л)" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400" required>
                    <select id="newGlucoseType" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50">
                        <option value="before">До еды</option>
                        <option value="after">После еды</option>
                        <option value="random">Произвольно</option>
                    </select>
                    <textarea id="newGlucoseNotes" placeholder="Заметки (необязательно)" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400" rows="2"></textarea>
                    <div class="flex space-x-3">
                        <button type="submit" class="flex-1 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-700 transition-colors">Добавить измерение</button>
                        <button type="button" id="cancelAddGlucoseBtn" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 dark:bg-slate-600 dark:text-gray-200 dark:hover:bg-slate-500 transition-colors">Отмена</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Модальное окно настроек ИИ-помощника -->
        <div id="aiSettingsModal" class="modal fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-md dark:bg-slate-800">
                <h3 class="text-lg font-semibold mb-6 dark:text-gray-100">Настройки ИИ-помощника</h3>
                
                <!-- Кнопки выбора API -->
                <div class="api-selector-buttons mb-4 flex flex-wrap gap-2">
                    <button type="button" class="api-selector-btn" data-api="gemini">Gemini</button>
                    <button type="button" class="api-selector-btn" data-api="deepseek">DeepSeek</button>
                    <button type="button" class="api-selector-btn" data-api="chatgpt">ChatGPT</button>
                    <button type="button" class="api-selector-btn" data-api="openrouter">OpenRouter</button>
                    <button type="button" class="api-selector-btn" data-api="local">LM Studio</button>
                </div>

                <form id="aiSettingsForm" class="space-y-6">
                    <!-- Gemini API -->
                    <div class="api-section" data-api="gemini" style="display: none;">
                        <label for="geminiApiKey" class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i data-lucide="key-round" class="w-4 h-4 mr-2"></i>
                            API-ключ Google Gemini
                        </label>
                        <input type="password" id="geminiApiKey" placeholder="Введите ваш API-ключ" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400">
                        <div class="mt-2 flex items-center">
                            <input type="radio" id="defaultGemini" name="defaultModel" value="gemini" class="w-4 h-4 text-blue-600">
                            <label for="defaultGemini" class="ml-2 text-sm text-gray-600 dark:text-gray-400">Использовать по умолчанию</label>
                        </div>
                    </div>

                    <!-- DeepSeek API -->
                    <div class="api-section" data-api="deepseek" style="display: none;">
                        <label for="deepseekApiKey" class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i data-lucide="key-round" class="w-4 h-4 mr-2"></i>
                            API-ключ DeepSeek
                        </label>
                        <input type="password" id="deepseekApiKey" placeholder="Введите ваш API-ключ DeepSeek" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400">
                        <div class="mt-2 flex items-center">
                            <input type="radio" id="defaultDeepseek" name="defaultModel" value="deepseek" class="w-4 h-4 text-blue-600">
                            <label for="defaultDeepseek" class="ml-2 text-sm text-gray-600 dark:text-gray-400">Использовать по умолчанию</label>
                        </div>
                    </div>

                    <!-- ChatGPT API -->
                    <div class="api-section" data-api="chatgpt" style="display: none;">
                        <label for="chatgptApiKey" class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i data-lucide="key-round" class="w-4 h-4 mr-2"></i>
                            API-ключ ChatGPT
                        </label>
                        <input type="password" id="chatgptApiKey" placeholder="Введите ваш API-ключ ChatGPT" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400">
                        <div class="mt-2 flex items-center">
                            <input type="radio" id="defaultChatgpt" name="defaultModel" value="chatgpt" class="w-4 h-4 text-blue-600">
                            <label for="defaultChatgpt" class="ml-2 text-sm text-gray-600 dark:text-gray-400">Использовать по умолчанию</label>
                        </div>
                    </div>

                    <!-- OpenRouter API -->
                    <div class="api-section" data-api="openrouter" style="display: none;">
                        <label for="openrouterApiKey" class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i data-lucide="key-round" class="w-4 h-4 mr-2"></i>
                            API-ключ OpenRouter
                        </label>
                        <input type="password" id="openrouterApiKey" placeholder="Введите ваш API-ключ OpenRouter" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400">
                        <div class="mt-2">
                            <label for="openrouterModelSelect" class="block text-sm text-gray-600 dark:text-gray-400 mb-1">Выберите модель:</label>
                            <select id="openrouterModelSelect" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50">
                                <!-- OpenRouter API models добавление имён моделей для выподающего списка-->
                                <option value="meta-llama/llama-3.3-70b-instruct:free">Meta: Llama 3.3 70B Instruct (free)</option>
                                <option value="deepseek/deepseek-chat-v3-0324:free">DeepSeek V3 0324 (free)</option>
                                <option value="google/gemma-3-27b-it:free">Google: Gemma 3 27B (free)</option>
                                <option value="deepseek/deepseek-r1-0528-qwen3-8b:free">deepseek/deepseek-r1-0528-qwen3-8b:free</option>
                                <option value="mistralai/mistral-7b-instruct:free">mistralai/mistral-7b-instruct:free</option>
                                <option value="google/gemma-7b-it:free">google/gemma-7b-it:free</option>
                                <option value="anthropic/claude-3-opus:beta">anthropic/claude-3-opus:beta</option>
                                <option value="anthropic/claude-3-sonnet:beta">anthropic/claude-3-sonnet:beta</option>
                            </select>
                        </div>
                        <div class="mt-2 flex items-center">
                            <input type="radio" id="defaultOpenrouter" name="defaultModel" value="openrouter" class="w-4 h-4 text-blue-600">
                            <label for="defaultOpenrouter" class="ml-2 text-sm text-gray-600 dark:text-gray-400">Использовать по умолчанию</label>
                        </div>
                    </div>

                    <!-- LM Studio -->
                    <div class="api-section" data-api="local" style="display: none;">
                        <label for="lmStudioUrl" class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i data-lucide="server" class="w-4 h-4 mr-2"></i>
                            Локальная модель (LM Studio)
                        </label>
                        <input type="text" id="lmStudioUrl" placeholder="http://localhost:1234/v1" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400">
                        <div class="mt-2">
                            <label for="localModelSelect" class="block text-sm text-gray-600 dark:text-gray-400 mb-1">Выберите модель:</label>
                            <select id="localModelSelect" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50">
                                <option value="">Загрузка моделей...</option>
                            </select>
                        </div>
                        <div class="mt-2 flex items-center">
                            <input type="radio" id="defaultLocal" name="defaultModel" value="local" class="w-4 h-4 text-blue-600">
                            <label for="defaultLocal" class="ml-2 text-sm text-gray-600 dark:text-gray-400">Использовать по умолчанию</label>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-3 pt-4">
                        <button type="submit" id="saveAiSettingsBtn" class="flex-1 bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600 dark:bg-purple-600 dark:hover:bg-purple-700 transition-colors flex items-center justify-center">
                            <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                            Сохранить
                        </button>
                        <button type="button" id="cancelAiSettingsBtn" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 dark:bg-slate-600 dark:text-gray-200 dark:hover:bg-slate-500 transition-colors flex items-center justify-center">
                            <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                            Отмена
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>
    <script src="ai_predictor.js"></script>
    <script src="script.js"></script>
</body>
</html>