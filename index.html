<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дневник диабетика</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles for Diary App */
        .modal {
            display: none; /* Hidden by default */
        }
        .modal.show {
            display: flex; /* Show when active */
        }
        /* Ensure charts are responsive */
        .chart-container {
            position: relative;
            height: 250px; /* Adjust as needed */
            width: 100%;
        }

        /* Styles for Integrated Calculator */
        #calculatorHost {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            
            color: #ebebeb; /* Default text color for calculator view */
        }

        #calculatorHost h1, #calculatorHost h2, #calculatorHost h3 { color: #0062cc; text-align: center; }
        #calculatorHost h1 { font-size: 1.8em; margin-bottom: 20px;}
        #calculatorHost h2 { margin-top: 30px; color: #117a8b; font-size: 1.5em; margin-bottom: 15px;}        
        #calculatorHost label {
            display: flex; align-items: center; 
            margin-top: 18px; margin-bottom: 6px; font-weight: 600; color: #9f9f9f;
        }
        #calculatorHost input[type="number"], #calculatorHost select {
            width: 100%; /* Занимает всю доступную ширину родителя */
            padding: 12px; margin-top: 6px;
            border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; font-size: 1em;
            color: #333; /* Ensure text is visible on light inputs */
        }
        #calculatorHost input[type="number"]:focus, #calculatorHost select:focus {
            border-color: #7abaff; outline: 0; box-shadow: 0 0 0 0.25rem rgba(0, 102, 204, 0.25);
        }
        #calculatorHost button { /* General button style for calculator */
            background-color: #0062cc; color: white; padding: 14px 20px;
            border: none; border-radius: 6px; cursor: pointer;
            font-size: 1.1em; transition: background-color 0.2s ease-in-out, transform 0.1s ease;
            box-sizing: border-box;
        }
        #calculatorHost button:hover { background-color: #004c9e; transform: translateY(-1px); }
        #calculatorHost button:active { transform: translateY(0px); }
        #calculatorHost button.save-settings { background-color: #20c997; }
        #calculatorHost button.save-settings:hover { background-color: #18a277; }

        .result-section {
            margin-top: 35px; padding: 25px;
            border-radius: 8px; border: 1px solid #d1d9e0;
        }
        .result-section p { margin: 12px 0; font-size: 1.05em; }
        .result-section strong { color: #0062cc; }
        #predictedSugarResult { font-size: 1.5em !important; font-weight: bold;}

        .disclaimer-bottom {
            margin-top: 25px; padding: 20px; background-color: #ffeeba;
            color: #725c0d; border: 1px solid #fddc9d; border-radius: 8px; text-align: justify;
        }
        .error-message { color: #c82333; font-size: 0.9em; margin-top: 6px; }
        .info-tooltip-icon {
            display: inline-flex; 
            justify-content: center;
            align-items: center;
            width: 22px; height: 22px; 
            border-radius: 50%;
            background-color: #007bff;
            color: white;
            text-align: center;
            font-weight: bold;
            margin-left: 8px;
            cursor: pointer;
            user-select: none; 
            font-size: 0.85em; 
            flex-shrink: 0; 
        }
        .info-tooltip-icon:hover { background-color: #0056b3; }
        
        .popup-overlay { /* For calculator's popup */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.65); 
            display: none; justify-content: center; align-items: center;
            z-index: 1000; padding: 15px; box-sizing: border-box;
        }
        .popup-content { /* For calculator's popup */
            background-color: white; padding: 20px; 
            border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            max-width: 500px; width: 95%; 
            text-align: left; position: relative; 
            max-height: 85vh; 
            overflow-y: auto; 
            box-sizing: border-box;
        }
        .popup-content h4 {
            margin-top: 0; color: #0062cc; font-size: 1.2em; 
            margin-bottom: 15px;
        }
        .popup-content p, .popup-content ul {
            font-size: 0.95em; 
            line-height: 1.6; color: #333; margin-bottom: 10px;
        }
        .popup-content ul { padding-left: 20px; }
        .popup-close-btn {
            position: absolute; top: 8px; right: 12px; 
            font-size: 2em; 
            font-weight: bold; color: #aaa; cursor: pointer;
            background: none; border: none; padding: 5px; line-height: 1;
        }
        .popup-close-btn:hover { color: #333; }

        .settings-section { border: 1px solid #20c997; padding: 25px; border-radius: 8px; margin-bottom: 35px;}
        .calc-coeffs-display { padding:10px; border-radius: 5px; margin-bottom:15px; font-size:0.9em;}
        .calc-coeffs-display strong { display: block; margin-bottom: 5px; }
        .calc-coeffs-display label {
            display: inline-block; 
            margin-right: 10px;
            margin-top: 5px;
        }
        .calc-coeffs-display input { 
            width: 65px !important; 
            padding: 6px !important; margin-left:3px; 
            text-align: center; font-size: 0.95em;
            
        }

        /* --- Calculator Adaptive styles --- */
        @media (max-width: 768px) {
            #calculatorHost { padding: 15px; }
            #calculatorHost .container { padding: 20px; margin-bottom: 20px; }
            .top-disclaimer { padding: 15px; font-size: 1em; }
            .top-disclaimer strong { font-size: 1.1em; }

            #calculatorHost h1 { font-size: 1.6em; }
            #calculatorHost h2 { font-size: 1.3em; }
            #calculatorHost h3 { font-size: 1.15em; }

            #calculatorHost input[type="number"], #calculatorHost select { padding: 10px; font-size: 0.95em; }
            #calculatorHost button { padding: 12px 18px; font-size: 1em; }
            .result-section { padding: 20px; }
            .result-section p { font-size: 1em; }
            #predictedSugarResult { font-size: 1.3em !important; }
            .settings-section, .result-section { padding: 20px; }
            .disclaimer-bottom { padding: 15px; font-size: 0.9em; }
            .popup-content { padding: 20px; } /* Calculator popup */
            .popup-content h4 { font-size: 1.1em; }
            .popup-content p, .popup-content ul { font-size: 0.9em; }
        }

        @media (max-width: 480px) {
            #calculatorHost { padding: 10px; }
            #calculatorHost .container { padding: 15px; }
            .top-disclaimer { padding: 10px; font-size: 0.9em; margin-bottom: 15px; }
            .top-disclaimer strong { font-size: 1em; }
            
            #calculatorHost h1 { font-size: 1.4em; margin-bottom: 15px; }
            #calculatorHost h2 { font-size: 1.2em; margin-top: 20px; margin-bottom: 10px; }
            #calculatorHost h3 { font-size: 1.1em; margin-top: 20px; margin-bottom: 8px; }

            #calculatorHost label { margin-top: 15px; font-size: 0.95em; }
            #calculatorHost input[type="number"], #calculatorHost select { padding: 10px; font-size: 0.9em; }
            #calculatorHost button { padding: 12px 15px; font-size: 1em; margin-top: 20px;}
            
            .result-section p { font-size: 0.95em; }
            #predictedSugarResult { font-size: 1.2em !important; }
            
            .settings-section, .result-section { padding: 15px; }
            .disclaimer-bottom { padding: 10px; font-size: 0.85em; }

            .info-tooltip-icon { width: 20px; height: 20px; line-height: 20px; font-size: 0.75em; }
            
            .popup-content { width: 95%; padding: 15px; } /* Calculator popup */
            .popup-content h4 { font-size: 1.05em; }
            .popup-content p, .popup-content ul { font-size: 0.85em; }
            .popup-close-btn { top: 5px; right: 8px; font-size: 1.8em; }

            .calc-coeffs-display strong { font-size: 0.95em; }
            .calc-coeffs-display label { font-size: 0.9em; margin-right: 5px; }
            .calc-coeffs-display input { width: 60px !important; font-size: 0.9em;}
        }

        /* --- Адаптив для навигации --- */
        @media (max-width: 768px) {
            .fixed.bottom-0.left-0.right-0.bg-white {
                padding-bottom: env(safe-area-inset-bottom, 0);
                height: 70px;
                min-height: 70px;
                border-radius: 18px 18px 0 0;
                box-shadow: 0 -2px 16px rgba(0,0,0,0.08);
            }
            #navigation-buttons {
                gap: 0.5rem;
            }
            .nav-button {
                flex: 1 1 0%;
                min-width: 0;
                padding: 0.5rem 0 0.2rem 0;
                border-radius: 12px;
                margin: 0 2px;
                font-size: 1.05em;
            }
            .nav-button i {
                width: 2.1rem !important;
                height: 2.1rem !important;
                margin-bottom: 0.1rem;
            }
            .nav-button span {
                font-size: 0.90em;
                font-weight: 500;
                line-height: 1.1;
                letter-spacing: -0.01em;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                display: block;
                text-align: center;
            }
        }
        @media (max-width: 480px) {
            .fixed.bottom-0.left-0.right-0.bg-white {
                height: 64px;
                min-height: 64px;
                border-radius: 16px 16px 0 0;
                box-shadow: 0 -2px 18px rgba(0,0,0,0.13);
            }
            #navigation-buttons {
                gap: 0.2rem;
            }
            .nav-button {
                padding: 0.3rem 0 0.1rem 0;
                font-size: 1em;
            }
            .nav-button i {
                width: 1.7rem !important;
                height: 1.7rem !important;
            }
            .nav-button span {
                font-size: 0.80em;
                line-height: 1.05;
                max-width: 80%;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                display: block;
                text-align: center;
            }
            /* Добавлено: скрываем подписи в навигации на мобильных */
            .nav-button span { display: none; }
        }
        /* --- END OF COPIED CALCULATOR STYLES --- */

    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-slate-900 dark:to-slate-800 transition-colors duration-300">
    <div id="app" class="container mx-auto p-4 max-w-7xl">
        <!-- Заголовок -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 dark:bg-slate-800">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-2">Дневник диабетика</h1>
                    <p class="text-gray-600 dark:text-gray-300">Управление питанием, контроль глюкозы и расчет дозы инсулина</p>
                </div>
                <button id="darkModeToggle" title="Переключить тему" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
                    {/* Icon will be set by JavaScript */}
                </button>
            </div>
        </div>

        <!-- Навигация -->
        <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-800 shadow-lg border-t border-gray-200 dark:border-slate-700 z-50">
            <div id="navigation-buttons" class="flex justify-around items-center max-w-7xl mx-auto px-2 py-2">
                <button data-view="calendar" class="nav-button flex flex-col items-center px-3 py-2 rounded-lg transition-colors">
                    <i data-lucide="calendar" class="w-6 h-6 mb-1"></i>
                    <span class="text-xs">Календарь</span>
                </button>
                <button data-view="analytics" class="nav-button flex flex-col items-center px-3 py-2 rounded-lg transition-colors">
                    <i data-lucide="trending-up" class="w-6 h-6 mb-1"></i>
                    <span class="text-xs">Аналитика</span>
                </button>
                <button data-view="reports" class="nav-button flex flex-col items-center px-3 py-2 rounded-lg transition-colors">
                    <i data-lucide="bar-chart-3" class="w-6 h-6 mb-1"></i>
                    <span class="text-xs">Отчеты</span>
                </button>
                <button data-view="products" class="nav-button flex flex-col items-center px-3 py-2 rounded-lg transition-colors">
                    <i data-lucide="database" class="w-6 h-6 mb-1"></i>
                    <span class="text-xs">Продукты</span>
                </button>
                <button data-view="calculator" class="nav-button flex flex-col items-center px-3 py-2 rounded-lg transition-colors">
                    <i data-lucide="calculator" class="w-6 h-6 mb-1"></i>
                    <span class="text-xs">Калькулятор</span>
                </button>
            </div>
        </div>

        <!-- Добавляем отступ снизу для контента -->
        <div class="pb-20">
        <!-- Календарь View -->
        <div id="calendarView" class="view-content grid grid-cols-1 xl:grid-cols-3 gap-6">
            <!-- Календарная сетка (takes 1/3 width on XL) -->
            <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                <h2 id="calendarHeader" class="text-xl font-semibold mb-4 dark:text-gray-100"></h2>
                <div class="grid grid-cols-7 gap-2 mb-4">
                    <!-- Дни недели -->
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-2">
                    <!-- Дни -->
                </div>
                 <!-- Export/Import Buttons -->
                 <div class="mt-6 flex space-x-2 justify-center">
                    <button id="exportDayDataBtn" class="bg-purple-500 text-white px-3 py-1.5 rounded-lg hover:bg-purple-600 dark:bg-purple-600 dark:hover:bg-purple-700 transition-colors flex items-center text-xs sm:text-sm">
                        <i data-lucide="download" class="w-4 h-4 mr-1.5"></i> Экспорт дня
                    </button>
                    <button id="importDataBtn" class="bg-teal-500 text-white px-3 py-1.5 rounded-lg hover:bg-teal-600 dark:bg-teal-600 dark:hover:bg-teal-700 transition-colors flex items-center text-xs sm:text-sm">
                        <i data-lucide="upload" class="w-4 h-4 mr-1.5"></i> Импорт
                    </button>
                    <button id="exportAllDataBtn" class="bg-orange-500 text-white px-3 py-1.5 rounded-lg hover:bg-orange-600 dark:bg-orange-600 dark:hover:bg-orange-700 transition-colors flex items-center text-xs sm:text-sm">
                        <i data-lucide="archive" class="w-4 h-4 mr-1.5"></i> Экспорт всех
                    </button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display: none;">
            </div>

            <!-- Right panel for selected day's details (takes 2/3 width on XL, stacking content vertically) -->
            <div class="xl:col-span-2 space-y-6"> 
                <!-- Predicted Sugar Section (New) -->
                <div id="predictedSugarSection" class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800" style="display: none;">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-semibold dark:text-gray-100">Прогноз текущего сахара</h2>
                        <button id="correctPredictionBtn" class="bg-green-500 text-white px-3 py-1.5 rounded-lg hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 transition-colors flex items-center text-sm">
                            <i data-lucide="edit-3" class="w-4 h-4 mr-1.5"></i> Внести измерение
                        </button>
                    </div>
                    <div id="predictedSugarDisplay" class="text-3xl font-bold mb-1">
                        {/* Prediction will be shown here */}
                    </div>
                    <p id="predictionContext" class="text-xs text-gray-500 dark:text-gray-400"></p>
                </div>

                

                <!-- Приемы пищи за день -->
                <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="mealsHeader" class="text-xl font-semibold dark:text-gray-100">Питание</h2>
                        <button id="showAddMealModalBtn" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 transition-colors">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="dayMealsContainer" class="space-y-4 max-h-96 overflow-y-auto">
                        {/* Записи о приемах пищи */}
                    </div>
                </div>

                <!-- Уровень глюкозы за день -->
                <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="glucoseHeader" class="text-xl font-semibold dark:text-gray-100">Глюкоза</h2>
                        <button id="showAddGlucoseModalBtn" class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-700 transition-colors">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="dayGlucoseContainer" class="space-y-3 max-h-96 overflow-y-auto">
                        {/* Записи глюкозы */}
                    </div>
                    <div id="dayGlucoseChartContainer" class="mt-6" style="display: none;">
                        <h3 class="text-sm font-medium mb-2 dark:text-gray-300">График за день</h3>
                        <div class="chart-container h-32">
                            <canvas id="dayGlucoseChartCanvas"></canvas>
                        </div>
                    </div>
                    
                </div>
                <!-- Дневная сводка -->
                <div id="daySummaryContainer" class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                    <h2 class="text-xl font-semibold mb-4 dark:text-gray-100">Сводка за день</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 rounded-lg p-4 dark:bg-slate-700">
                            <div id="dayTotalCarbs" class="text-2xl font-bold text-blue-600 dark:text-blue-400">0г</div>
                            <div class="text-sm text-blue-600 dark:text-blue-400">Углеводы</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 dark:bg-slate-700">
                            <div id="dayTotalInsulin" class="text-2xl font-bold text-green-600 dark:text-green-400">0 ед</div>
                            <div class="text-sm text-green-600 dark:text-green-400">Инсулин</div>
                        </div>
                        <div class="bg-red-50 rounded-lg p-4 dark:bg-slate-700">
                            <div id="dayAvgGlucose" class="text-2xl font-bold text-red-600 dark:text-red-400">0</div>
                            <div class="text-sm text-red-600 dark:text-red-400">Средняя глюкоза</div>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-4 dark:bg-slate-700">
                            <div id="dayMealsCount" class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">0</div>
                            <div class="text-sm text-yellow-600 dark:text-yellow-400">Приемов пищи</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Аналитика View -->
        <div id="analyticsView" class="view-content space-y-8" style="display: none;">
            <!-- Недельная аналитика -->
            <div class="space-y-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Аналитика за неделю</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-100">Средний уровень глюкозы</h3>
                        <div class="chart-container h-64">
                            <canvas id="weekGlucoseChartCanvas"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-100">Углеводы и инсулин</h3>
                        <div class="chart-container h-64">
                            <canvas id="carbsInsulinChartCanvas"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-100">Активность</h3>
                        <div class="chart-container h-64">
                            <canvas id="activityChartCanvas"></canvas>
                        </div>
                    </div>
                    <div id="weekSummaryContainer" class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-100">Сводка</h3>
                        <!-- Сводка будет вставлена сюда -->
                    </div>
                </div>
            </div>

            <!-- Месячная аналитика -->
            <div class="space-y-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Аналитика за месяц</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-100">Средний уровень глюкозы</h3>
                        <div class="chart-container h-64">
                            <canvas id="monthGlucoseChartCanvas"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-100">Углеводы и инсулин</h3>
                        <div class="chart-container h-64">
                            <canvas id="monthCarbsInsulinChartCanvas"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-100">Активность</h3>
                        <div class="chart-container h-64">
                            <canvas id="monthActivityChartCanvas"></canvas>
                        </div>
                    </div>
                    <div id="monthSummaryContainer" class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-100">Сводка</h3>
                        <!-- Сводка будет вставлена сюда -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Отчеты View -->
        <div id="reportsView" class="view-content space-y-6" style="display: none;">
            <div class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                <h2 class="text-xl font-semibold mb-4 dark:text-gray-100">Детальный отчет за неделю</h2>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead class="dark:text-gray-200">
                            <tr class="bg-gray-50 dark:bg-slate-700">
                                <th class="border p-3 text-left dark:border-slate-600">Дата</th>
                                <th class="border p-3 text-left dark:border-slate-600">Приемы пищи</th>
                                <th class="border p-3 text-left dark:border-slate-600">Углеводы (г)</th>
                                <th class="border p-3 text-left dark:border-slate-600">Инсулин (ед)</th>
                                <th class="border p-3 text-left dark:border-slate-600">Ср. глюкоза</th>
                                <th class="border p-3 text-left dark:border-slate-600">Измерения</th>
                            </tr>
                        </thead>
                        <tbody id="weekReportTableBody" class="dark:text-gray-300 dark:border-slate-600">
                            <!-- Данные отчета -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div id="glucoseControlAnalysisContainer" class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                    <h3 class="text-lg font-semibold mb-4 dark:text-gray-100">Анализ контроля глюкозы</h3>
                    <!-- Анализ будет вставлен сюда -->
                </div>
                <div id="recommendationsContainer" class="bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800">
                    <h3 class="text-lg font-semibold mb-4 dark:text-gray-100">Рекомендации</h3>
                    <!-- Рекомендации -->
                </div>
            </div>
        </div>

        <!-- Продукты View -->
        <div id="productsView" class="view-content bg-white rounded-xl shadow-lg p-6 dark:bg-slate-800" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold dark:text-gray-100">Реестр продуктов</h2>
                <button id="showAddProductModalBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 transition-colors flex items-center">
                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Добавить продукт
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead class="dark:text-gray-200">
                        <tr class="bg-gray-50 dark:bg-slate-700">
                            <th class="border p-3 text-left dark:border-slate-600">Продукт</th>
                            <th class="border p-3 text-left dark:border-slate-600">Углеводы (г/100г)</th>
                            <th class="border p-3 text-left dark:border-slate-600">Инсулин (ед/ХЕ)</th>
                            <th class="border p-3 text-left dark:border-slate-600">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody" class="dark:text-gray-300 dark:border-slate-600">
                        <!-- Список продуктов -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Калькулятор View -->
        <div id="calculatorView" class="view-content" style="display: none;">
            <div id="calculatorHost">
                <div class="container"> <!-- This is the calculator's .container -->
                    <h1>Персональный калькулятор сахара (Адаптивный)</h1>
            
                    <div class="settings-section">
                        <h3>Ваши индивидуальные коэффициенты <span class="info-tooltip-icon" onclick="showPopup('settingsInfo')">?</span></h3>
                        <p class="info-tooltip" style="font-size: 0.85em; color: #5a6268;">Значения должны быть согласованы с вашим врачом.</p>
                        
                        <label for="settingCarbRatio">Углеводный коэффициент (УК) <span class="info-tooltip-icon" onclick="showPopup('carbRatioInfo')">?</span></label>
                        <input type="number" id="settingCarbRatio" step="0.1">
                        <div class="error-message" id="settingCarbRatioError"></div>
            
                        <label for="settingSensitivityFactor">Фактор чувствительности к инсулину (ФЧИ) <span class="info-tooltip-icon" onclick="showPopup('sensitivityFactorInfo')">?</span></label>
                        <input type="number" id="settingSensitivityFactor" step="0.1">
                        <div class="error-message" id="settingSensitivityFactorError"></div>
            
                        <label for="settingTargetSugar">Целевой уровень сахара <span class="info-tooltip-icon" onclick="showPopup('targetSugarInfo')">?</span></label>
                        <input type="number" id="settingTargetSugar" step="0.1">
                        <div class="error-message" id="settingTargetSugarError"></div>
            
                        <button type="button" class="save-settings" onclick="saveSettings()">Сохранить мои коэффициенты</button>
                    </div>
            
                    <h2>Расчет прогноза (на ~2 часа после еды):</h2>
                    <form id="diabetesForm">
                        <div class="calc-coeffs-display">
                            <strong>Используемые коэффициенты:</strong><br>
                            <label for="calcCarbRatio">УК: <input type="number" id="calcCarbRatio" step="0.1" readonly></label>
                            <label for="calcSensitivityFactor">ФЧИ: <input type="number" id="calcSensitivityFactor" step="0.1" readonly></label>
                            <label for="calcTargetSugar">Цель: <input type="number" id="calcTargetSugar" step="0.1" readonly></label>
                        </div>
            
                        <label for="currentSugar">1. Текущий уровень сахара (ммоль/л) <span class="info-tooltip-icon" onclick="showPopup('currentSugarInfo')">?</span></label>
                        <input type="number" id="currentSugar" name="currentSugar" step="0.1" required>
                        <div class="error-message" id="currentSugarError"></div>
            
                        <label for="carbs">2. Количество углеводов в пище (граммы) <span class="info-tooltip-icon" onclick="showPopup('carbsInfo')">?</span></label>
                        <input type="number" id="carbs" name="carbs" step="1" required>
                        <div class="error-message" id="carbsError"></div>
            
                        <label for="mealType">3. Тип пищи <span class="info-tooltip-icon" onclick="showPopup('mealTypeInfo')">?</span></label>
                        <select id="mealType" name="mealType">
                            <option value="balanced" selected>Сбалансированная еда (стандарт)</option>
                            <option value="fast">Преимущественно быстрые углеводы</option>
                            <option value="slow">Медленные углеводы / Жирная/белковая пища</option>
                        </select>
            
                        <label for="activityLevel">4. Физическая активность <span class="info-tooltip-icon" onclick="showPopup('activityLevelInfo')">?</span></label>
                        <select id="activityLevel" name="activityLevel">
                            <option value="none" selected>Без значительной активности</option>
                            <option value="light">Легкая (прогулка)</option>
                            <option value="moderate">Умеренная/Интенсивная</option>
                        </select>
                        
                        <label for="insulinDose">5. Введенная доза инсулина (ед.) <span class="info-tooltip-icon" onclick="showPopup('insulinDoseInfo')">?</span></label>
                        <input type="number" id="insulinDose" name="insulinDose" step="0.1" required>
                        <div class="error-message" id="insulinDoseError"></div>
            
                        <button type="button" onclick="calculatePrediction()">Рассчитать прогноз</button>
                    </form>
            
                    <div class="result-section" id="predictionArea" style="display:none;">
                         <h2>Результаты расчета:</h2>
                        <p>Расчетная доза инсулина на еду (РД<sub>еда</sub>): <strong id="foodDoseResult">--</strong> ед.</p>
                        <p>Расчетная доза инсулина на коррекцию (РД<sub>корр</sub>): <strong id="correctionDoseResult">--</strong> ед.</p>
                        <p><strong>Общая расчетная потребность в инсулине (ОРПИ):</strong> <strong id="totalCalculatedDoseResult">--</strong> ед.</p>
                        <hr>
                        <p>Вы ввели: <strong id="enteredDoseDisplay">--</strong> ед. инсулина.</p>
                        <p>Разница (Введенная доза - ОРПИ): <strong id="doseDifferenceResult">--</strong> ед.</p>
                        <hr>
                        <p><strong>Приблизительный прогнозируемый уровень сахара через ~2 часа:</strong> <br><strong id="predictedSugarResult">--</strong> ммоль/л</p>
                        <p id="additionalComments" style="font-style: italic; margin-top:15px;"></p>
                    </div>
                     
                </div>
            
                <!-- Popup Overlay and Content for Calculator -->
                <div class="popup-overlay" id="popupOverlay" onclick="closePopupOnClickOutside(event)">
                    <div class="popup-content" id="popupContentContainer">
                        
                        <h4 id="popupTitle">Заголовок подсказки</h4>
                        <div id="popupText">Текст подсказки здесь...</div>
                        <button class="popup-close-btn" onclick="hidePopup()">&times;</button>
                    </div>
                    
                </div>
            </div>
        </div>


        <!-- Модальное окно добавления/редактирования продукта -->
        <div id="addProductModal" class="modal fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-md dark:bg-slate-800">
                <h3 id="addProductModalTitle" class="text-lg font-semibold mb-4 dark:text-gray-100">Добавить продукт</h3>
                <form id="addProductForm" class="space-y-4">
                    <input type="hidden" id="editingProductId">
                    <input type="text" id="newProductName" placeholder="Название продукта" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400" required>
                    <input type="number" id="newProductCarbs" placeholder="Углеводы (г на 100г продукта)" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400" required step="0.1">
                    <input type="number" id="newProductInsulinRatio" placeholder="Инсулин (единиц на 1 ХЕ)" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400" required step="0.1">
                    <div class="flex space-x-3">
                        <button type="submit" id="addProductSubmitBtn" class="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 transition-colors">Добавить</button>
                        <button type="button" id="cancelAddProductBtn" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 dark:bg-slate-600 dark:text-gray-200 dark:hover:bg-slate-500 transition-colors">Отмена</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Модальное окно добавления приема пищи -->
        <div id="addMealModal" class="modal fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto dark:bg-slate-800">
                <h3 class="text-lg font-semibold mb-4 dark:text-gray-100">Добавить прием пищи</h3>
                <form id="addMealForm" class="space-y-4">
                    <input type="time" id="newMealTime" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:[color-scheme:dark]" required>
                    <div class="border rounded-lg p-4 dark:border-slate-700">
                        <h4 class="font-medium mb-3 dark:text-gray-200">Добавить продукт:</h4>
                        <div class="flex space-x-2 mb-3">
                            <select id="newMealSelectedProduct" class="flex-1 p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50">
                                <option value="">Выберите продукт</option>
                                <!-- Опции продуктов -->
                            </select>
                            <input type="number" id="newMealProductAmount" placeholder="Вес (г)" class="w-24 p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400" step="1" min="1">
                            <button type="button" id="addProductToMealBtn" class="px-3 py-2 rounded-lg bg-green-500 text-white hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 transition-colors">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div id="newMealProductsListContainer" class="border rounded-lg p-4 dark:border-slate-700" style="display:none;">
                        <h4 class="font-medium mb-3 dark:text-gray-200">Выбранные продукты:</h4>
                        <div id="newMealProductsList" class="space-y-2">
                            <!-- Список добавленных продуктов -->
                        </div>
                        <div id="newMealCalculation" class="mt-3 p-3 bg-blue-50 rounded dark:bg-slate-700 dark:text-gray-300" style="display:none;">
                            <!-- Расчеты -->
                        </div>
                    </div>
                    <input type="number" id="newMealActualInsulin" step="0.1" placeholder="Фактически введено инсулина (единиц)" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400">
                    <textarea id="newMealNotes" placeholder="Заметки (необязательно)" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400" rows="2"></textarea>
                    <div class="flex space-x-3">
                        <button type="submit" id="addMealSubmitBtn" class="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 transition-colors">Добавить прием пищи</button>
                        <button type="button" id="cancelAddMealBtn" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 dark:bg-slate-600 dark:text-gray-200 dark:hover:bg-slate-500 transition-colors">Отмена</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Модальное окно добавления измерения глюкозы -->
        <div id="addGlucoseModal" class="modal fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-md dark:bg-slate-800">
                <h3 class="text-lg font-semibold mb-4 dark:text-gray-100">Добавить измерение глюкозы</h3>
                <form id="addGlucoseForm" class="space-y-4">
                    <input type="time" id="newGlucoseTime" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:[color-scheme:dark]" required>
                    <input type="number" id="newGlucoseLevel" step="0.1" placeholder="Уровень глюкозы (ммоль/л)" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400" required>
                    <select id="newGlucoseType" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50">
                        <option value="before">До еды</option>
                        <option value="after">После еды</option>
                        <option value="random">Произвольно</option>
                    </select>
                    <textarea id="newGlucoseNotes" placeholder="Заметки (необязательно)" class="w-full p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-gray-50 dark:placeholder-gray-400" rows="2"></textarea>
                    <div class="flex space-x-3">
                        <button type="submit" class="flex-1 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-700 transition-colors">Добавить измерение</button>
                        <button type="button" id="cancelAddGlucoseBtn" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 dark:bg-slate-600 dark:text-gray-200 dark:hover:bg-slate-500 transition-colors">Отмена</button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <script>
        // --- START OF CALCULATOR JavaScript (copied from code (5).html, window.onload removed) ---
        const CR_KEY = 'diabetesCalcAdvPop_carbRatio'; 
        const SF_KEY = 'diabetesCalcAdvPop_sensitivityFactor';
        const TS_KEY = 'diabetesCalcAdvPop_targetSugar';

        const popupData = {
            settingsInfo: {
                title: "Индивидуальные коэффициенты",
                text: `<p>Эти коэффициенты являются ключевыми для персонализации расчетов. <strong>Они должны быть определены строго совместно с вашим лечащим врачом-эндокринологом.</strong> Неправильно установленные коэффициенты приведут к неверным расчетам и потенциально опасным выводам.</p>
                       <p>Сохраняются в памяти вашего браузера (localStorage) и будут автоматически загружаться при следующем посещении страницы с этого же устройства и браузера.</p>`
            },
            carbRatioInfo: {
                title: "Углеводный коэффициент (УК)",
                text: `<p><strong>УК (ед/10г угл.)</strong>: Показывает, сколько единиц короткого/ультракороткого инсулина требуется для усвоения 10 граммов углеводов (примерно 1 Хлебная Единица, ХЕ).</p>
                       <p>Например, если ваш УК = 1.5, это значит, что на каждые 10 грамм углеводов вам нужно 1.5 единицы инсулина.</p>
                       <p>Этот коэффициент может меняться в течение дня (например, утром УК часто выше). В данном калькуляторе используется одно значение УК.</p>
                       <p><strong>Типичные значения:</strong> 0.5 - 3.0 (очень индивидуально).</p>`
            },
            sensitivityFactorInfo: {
                title: "Фактор чувствительности к инсулину (ФЧИ)",
                text: `<p><strong>ФЧИ (ммоль/л на 1 ед.)</strong>: Показывает, на сколько ммоль/л снизит ваш уровень сахара в крови 1 единица введенного короткого/ультракороткого инсулина.</p>
                       <p>Например, если ваш ФЧИ = 2.0, это значит, что 1 единица инсулина снизит ваш сахар примерно на 2.0 ммоль/л.</p>
                       <p>Используется для расчета дозы инсулина на коррекцию высокого сахара. Также может меняться в течение дня или при болезни.</p>
                       <p><strong>Типичные значения:</strong> 1.0 - 5.0 (очень индивидуально, может быть и выше).</p>`
            },
            targetSugarInfo: {
                title: "Целевой уровень сахара",
                text: `<p><strong>Целевой уровень сахара (ммоль/л)</strong>: Это тот уровень сахара в крови, к которому вы стремитесь перед едой или к которому должен вернуться сахар через некоторое время после еды и действия инсулина.</p>
                       <p>Определяется индивидуально с вашим врачом. Может быть диапазон (например, 4.0 - 7.0 ммоль/л). Для расчетов здесь используется одно конкретное значение (например, середина вашего целевого диапазона перед едой).</p>
                       <p><strong>Типичные значения для цели перед едой:</strong> 4.0 - 7.0 ммоль/л.</p>`
            },
            currentSugarInfo: {
                title: "Текущий уровень сахара",
                text: `<p>Введите ваш текущий уровень глюкозы в крови, измеренный глюкометром, в ммоль/л.</p>
                       <p>Это отправная точка для всех расчетов. Точность этого значения критически важна.</p>`
            },
            carbsInfo: {
                title: "Количество углеводов в пище",
                text: `<p>Укажите общее количество усвояемых углеводов в граммах, которое вы планируете съесть или уже съели.</p>
                       <p>Для подсчета используйте информацию на упаковках продуктов, таблицы пищевой ценности или специализированные приложения. Точный подсчет углеводов – ключ к правильному расчету дозы инсулина на еду.</p>
                       <p>Помните, что 1 Хлебная Единица (ХЕ) ≈ 10-12 грамм углеводов.</p>`
            },
            mealTypeInfo: {
                title: "Тип пищи",
                text: `<p>Выбор типа пищи помогает калькулятору (очень упрощенно) учесть примерную скорость усвоения углеводов и их влияние на сахар в ближайшие ~2 часа.</p>
                       <ul>
                           <li><strong>Сбалансированная еда (стандарт):</strong> Обычный прием пищи, содержащий белки, жиры и углеводы.</li>
                           <li><strong>Преимущественно быстрые углеводы:</strong> Продукты, которые быстро повышают сахар (сок, фрукты, сладости).</li>
                           <li><strong>Медленные углеводы / Жирная/белковая пища:</strong> Еда, богатая жирами/белками, замедляющими всасывание углеводов.</li>
                       </ul>
                       <p>Этот параметр вносит лишь небольшую поправку в прогноз.</p>`
            },
            activityLevelInfo: {
                title: "Физическая активность",
                text: `<p>Укажите предполагаемый уровень физической активности в ближайшие 1-2 часа.</p>
                       <p>Физическая активность обычно повышает чувствительность к инсулину и помогает снижать уровень сахара.</p>
                       <ul>
                           <li><strong>Без значительной активности:</strong> Сидячий образ жизни.</li>
                           <li><strong>Легкая (прогулка):</strong> Неспешная ходьба.</li>
                           <li><strong>Умеренная/Интенсивная:</strong> Быстрая ходьба, спорт.</li>
                       </ul>
                       <p>Калькулятор применяет примерный фактор снижения сахара. Эффект индивидуален.</p>`
            },
            insulinDoseInfo: {
                title: "Введенная доза инсулина",
                text: `<p>Укажите дозу короткого или ультракороткого инсулина (в единицах) для компенсации этой еды и/или коррекции сахара.</p>
                       <p><strong>ВАЖНО:</strong> Этот калькулятор <strong>НЕ УЧИТЫВАЕТ активный инсулин (IOB)</strong> от предыдущих инъекций. Учет IOB критически важен, но требует более сложных моделей.</p>
                       <p>Вводите только дозу для ДАННОГО приема пищи/коррекции.</p>`
            }
        };

        function showPopup(popupId) { // Calculator's showPopup
            const data = popupData[popupId];
            if (data) {
                document.getElementById('popupTitle').textContent = data.title;
                document.getElementById('popupText').innerHTML = data.text;
                document.getElementById('popupOverlay').style.display = 'flex';
            }
        }

        function hidePopup() { // Calculator's hidePopup
            document.getElementById('popupOverlay').style.display = 'none';
        }
        
        function closePopupOnClickOutside(event) { // Calculator's specific logic
            if (event.target === document.getElementById('popupOverlay')) {
                hidePopup();
            }
        }

        function validateAndGetNumber(valueStr, fieldNameForError, errorElementId) {
            const numValue = parseFloat(valueStr);
            const errorElement = document.getElementById(errorElementId);
            if (errorElement) errorElement.textContent = '';

            if (valueStr === null || valueStr.trim() === '' || isNaN(numValue)) {
                if (errorElement) errorElement.textContent = `Введите числовое значение для "${fieldNameForError}".`;
                return null;
            }
            if (numValue < 0) {
                 if (errorElement) errorElement.textContent = `"${fieldNameForError}" не может быть отрицательным.`;
                return null;
            }
            
            if ((fieldNameForError.includes("УК") || fieldNameForError.includes("Углеводный коэффициент")) && (numValue === 0 || numValue > 10) ) {
                 if (errorElement) errorElement.textContent = `УК (0.1-10). Не 0.`; return null;
            }
            if ((fieldNameForError.includes("ФЧИ") || fieldNameForError.includes("Фактор чувствительности")) && (numValue === 0 || numValue > 25)) { 
                 if (errorElement) errorElement.textContent = `ФЧИ (0.5-25). Не 0.`; return null;
            }
             if ((fieldNameForError.includes("Целевой сахар")) && (numValue < 3 || numValue > 12)) {
                 if (errorElement) errorElement.textContent = `Цель (3-12 ммоль/л).`; return null;
            }
            if (fieldNameForError.includes("Текущий сахар") && (numValue < 1 || numValue > 40)) {
                 if (errorElement) errorElement.textContent = `Текущий сахар (1-40 ммоль/л).`; return null;
            }
             if (fieldNameForError.includes("Углеводы") && (numValue > 500)) { 
                 if (errorElement) errorElement.textContent = `>500г углеводов. Проверьте.`;
            }
            if (fieldNameForError.includes("Доза инсулина") && (numValue > 100)) { 
                 if (errorElement) errorElement.textContent = `>100ед инсулина. Проверьте.`;
            }
            return numValue;
        }

        function saveSettings() {
            document.querySelectorAll('#calculatorHost .settings-section .error-message').forEach(el => el.textContent = '');
            
            const carbRatio = validateAndGetNumber(document.getElementById('settingCarbRatio').value, "Углеводный коэффициент", "settingCarbRatioError");
            const sensitivityFactor = validateAndGetNumber(document.getElementById('settingSensitivityFactor').value, "Фактор чувствительности", "settingSensitivityFactorError");
            const targetSugar = validateAndGetNumber(document.getElementById('settingTargetSugar').value, "Целевой сахар", "settingTargetSugarError");

            if (carbRatio !== null && sensitivityFactor !== null && targetSugar !== null) {
                localStorage.setItem(CR_KEY, carbRatio.toString());
                localStorage.setItem(SF_KEY, sensitivityFactor.toString());
                localStorage.setItem(TS_KEY, targetSugar.toString());
                alert('Коэффициенты сохранены!');
                loadSettingsToCalcForm(); 
            } else {
                alert('Пожалуйста, исправьте ошибки в значениях коэффициентов.');
            }
        }

        function loadSettingsToCalcForm() {
            const cr = localStorage.getItem(CR_KEY);
            const sf = localStorage.getItem(SF_KEY);
            const ts = localStorage.getItem(TS_KEY);

            const crEl = document.getElementById('calcCarbRatio');
            const sfEl = document.getElementById('calcSensitivityFactor');
            const tsEl = document.getElementById('calcTargetSugar');
            const settingCrEl = document.getElementById('settingCarbRatio');
            const settingSfEl = document.getElementById('settingSensitivityFactor');
            const settingTsEl = document.getElementById('settingTargetSugar');

            if (cr && crEl && settingCrEl) { crEl.value = parseFloat(cr).toFixed(1); settingCrEl.value = parseFloat(cr).toFixed(1); } else if(crEl && settingCrEl) { crEl.value = ''; settingCrEl.value = '';}
            if (sf && sfEl && settingSfEl) { sfEl.value = parseFloat(sf).toFixed(1); settingSfEl.value = parseFloat(sf).toFixed(1); } else if(sfEl && settingSfEl) { sfEl.value = ''; settingSfEl.value = '';}
            if (ts && tsEl && settingTsEl) { tsEl.value = parseFloat(ts).toFixed(1); settingTsEl.value = parseFloat(ts).toFixed(1); } else if(tsEl && settingTsEl) { tsEl.value = ''; settingTsEl.value = '';}
        }
        
        function getCoefficientsForCalculation() {
            const carbRatioStr = document.getElementById('calcCarbRatio').value;
            const sensitivityFactorStr = document.getElementById('calcSensitivityFactor').value;
            const targetSugarStr = document.getElementById('calcTargetSugar').value;

            if (carbRatioStr === '' || sensitivityFactorStr === '' || targetSugarStr === '') {
                 alert("Пожалуйста, сначала установите и сохраните корректные индивидуальные коэффициенты в разделе настроек.");
                return null;
            }

            const carbRatio = validateAndGetNumber(carbRatioStr, "УК", "NoIDNeeded1"); // Error IDs are dummy here as they are not displayed
            const sensitivityFactor = validateAndGetNumber(sensitivityFactorStr, "ФЧИ", "NoIDNeeded2");
            const targetSugar = validateAndGetNumber(targetSugarStr, "Целевой сахар", "NoIDNeeded3");

            if (carbRatio === null || sensitivityFactor === null || targetSugar === null) {
                alert("Сохраненные коэффициенты некорректны. Пожалуйста, проверьте и пересохраните их в разделе настроек.");
                return null;
            }
            return { carbRatio, sensitivityFactor, targetSugar };
        }

        function calculatePrediction() {
            document.querySelectorAll('#diabetesForm .error-message').forEach(el => el.textContent = '');
            
            const currentSugar = validateAndGetNumber(document.getElementById('currentSugar').value, "Текущий сахар", "currentSugarError");
            const carbs = validateAndGetNumber(document.getElementById('carbs').value, "Количество углеводов", "carbsError");
            const insulinDose = validateAndGetNumber(document.getElementById('insulinDose').value, "Введенная доза инсулина", "insulinDoseError");
            const mealType = document.getElementById('mealType').value;
            const activityLevel = document.getElementById('activityLevel').value;
            
            const coeffs = getCoefficientsForCalculation();

            if (currentSugar === null || carbs === null || insulinDose === null || coeffs === null) {
                document.getElementById('predictionArea').style.display = 'none';
                return;
            }

            const { carbRatio, sensitivityFactor, targetSugar } = coeffs;

            const foodDose = (carbs / 10) * carbRatio;
            let correctionDose = 0;
            if (currentSugar > targetSugar) {
                correctionDose = (currentSugar - targetSugar) / sensitivityFactor;
            }
            correctionDose = Math.max(0, correctionDose); 
            const totalCalculatedDose = foodDose + correctionDose;

            let carbAbsorptionFactor = 1.0; 
            switch (mealType) {
                case 'fast': carbAbsorptionFactor = 1.1; break; 
                case 'balanced': carbAbsorptionFactor = 1.0; break;
                case 'slow': carbAbsorptionFactor = 0.80; break; 
            }

            let activityEffectOnSugar = 0; 
            switch (activityLevel) {
                case 'none': activityEffectOnSugar = 0; break;
                case 'light': activityEffectOnSugar = -0.8; break; 
                case 'moderate': activityEffectOnSugar = -2.0; break; 
            }

            const sugarIncreaseFromEffectiveCarbs = ((carbs * carbAbsorptionFactor) / 10) * carbRatio * sensitivityFactor;
            const sugarDecreaseFromInsulin = insulinDose * sensitivityFactor;
            let predictedSugar = currentSugar + sugarIncreaseFromEffectiveCarbs - sugarDecreaseFromInsulin + activityEffectOnSugar;

            if (predictedSugar < 0.5) predictedSugar = 0.5; 
            if (predictedSugar > 40.0) predictedSugar = 40.0;

            document.getElementById('foodDoseResult').textContent = foodDose.toFixed(1);
            document.getElementById('correctionDoseResult').textContent = correctionDose.toFixed(1);
            document.getElementById('totalCalculatedDoseResult').textContent = totalCalculatedDose.toFixed(1);
            document.getElementById('enteredDoseDisplay').textContent = insulinDose.toFixed(1);
            const doseDifference = insulinDose - totalCalculatedDose;
            document.getElementById('doseDifferenceResult').textContent = doseDifference.toFixed(1) + 
                (doseDifference > 0.1 ? " (введено больше ОРПИ)" : doseDifference < -0.1 ? " (введено меньше ОРПИ)" : " (введено по ОРПИ)");
            
            document.getElementById('predictedSugarResult').textContent = predictedSugar.toFixed(1);

            let comments = "Это КРАЙНЕ ПРИБЛИЗИТЕЛЬНЫЙ прогноз! Активный инсулин (IOB) НЕ учтен. ";
            if (predictedSugar < 3.9 && predictedSugar > 0.5) {
                comments += "Прогнозируется НИЗКИЙ уровень сахара. Будьте предельно внимательны, готовы к купированию гипогликемии. СРОЧНО обсудите с врачом, если прогнозы или реальные ситуации повторяются.";
            } else if (predictedSugar > 11.1 && predictedSugar < 40.0) {
                comments += "Прогнозируется ВЫСОКИЙ уровень сахара. Обсудите с врачом, если прогнозы или реальные ситуации повторяются, для коррекции терапии.";
            } else if (predictedSugar >= 3.9 && predictedSugar <= 11.1) {
                comments += "Прогнозируется уровень сахара в условно целевом диапазоне (для постпрандиального значения).";
            }
             comments += " Реальный сахар может ЗНАЧИТЕЛЬНО отличаться. ВСЕГДА проверяйте глюкометром!"
             document.getElementById('additionalComments').textContent = comments;
            document.getElementById('predictionArea').style.display = 'block';
        }
        // --- END OF CALCULATOR JavaScript ---


        // --- START OF DIARY APP JavaScript ---
        // --- STATE ---
        let currentView = 'calendar';
        
        function getLocalDateYYYYMMDD(dateObj) {
            const yearStr = dateObj.getFullYear();
            const monthStr = (dateObj.getMonth() + 1).toString().padStart(2, '0');
            const dayStr = dateObj.getDate().toString().padStart(2, '0');
            return `${yearStr}-${monthStr}-${dayStr}`;
        }
        let selectedDate = getLocalDateYYYYMMDD(new Date()); // Initial selectedDate is local YYYY-MM-DD

        let currentTheme = localStorage.getItem('diabetesAppTheme') || 'light';
        
        let products = JSON.parse(localStorage.getItem('diabetesAppProducts')) || [
            { id: 1, name: 'Хлеб белый', carbs: 50, insulinRatio: 1 }, 
            { id: 2, name: 'Рис отварной', carbs: 28, insulinRatio: 1.5 },
            { id: 3, name: 'Картофель отварной', carbs: 16, insulinRatio: 1 },
            { id: 4, name: 'Яблоко', carbs: 14, insulinRatio: 0.5 }, 
            { id: 5, name: 'Молоко 3.2%', carbs: 4.7, insulinRatio: 0.25 }
        ];
        let meals = JSON.parse(localStorage.getItem('diabetesAppMeals')) || {};
        let glucoseRecords = JSON.parse(localStorage.getItem('diabetesAppGlucoseRecords')) || {};

        let editingProductId = null; 
        let newMealFormState = { 
            products: []
        };

        // Chart instances
        let dayGlucoseChartInstance, weekGlucoseChartInstance, carbsInsulinChartInstance, activityChartInstance;
        let monthGlucoseChartInstance, monthCarbsInsulinChartInstance, monthActivityChartInstance;

        const monthNames = [
            'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
            'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
        ];

        // --- DOM Elements ---
        const navigationButtons = document.getElementById('navigation-buttons');
        const calendarViewEl = document.getElementById('calendarView');
        const analyticsViewEl = document.getElementById('analyticsView');
        const reportsViewEl = document.getElementById('reportsView');
        const productsViewEl = document.getElementById('productsView');
        const calculatorViewEl = document.getElementById('calculatorView'); 
        const viewContents = document.querySelectorAll('.view-content');

        const calendarHeaderEl = document.getElementById('calendarHeader');
        const calendarGridEl = document.getElementById('calendarGrid');
        const mealsHeaderEl = document.getElementById('mealsHeader');
        const dayMealsContainerEl = document.getElementById('dayMealsContainer');
        const glucoseHeaderEl = document.getElementById('glucoseHeader');
        const dayGlucoseContainerEl = document.getElementById('dayGlucoseContainer');
        const dayGlucoseChartContainerEl = document.getElementById('dayGlucoseChartContainer');
        
        const productsTableBodyEl = document.getElementById('productsTableBody');
        
        // Modals
        const addProductModalEl = document.getElementById('addProductModal');
        const addMealModalEl = document.getElementById('addMealModal');
        const addGlucoseModalEl = document.getElementById('addGlucoseModal');

        // Theme Toggle
        const darkModeToggleBtn = document.getElementById('darkModeToggle');

        // --- DOM Elements for Prediction (New) ---
        const predictedSugarSectionEl = document.getElementById('predictedSugarSection');
        const predictedSugarDisplayEl = document.getElementById('predictedSugarDisplay');
        const predictionContextEl = document.getElementById('predictionContext');
        const correctPredictionBtnEl = document.getElementById('correctPredictionBtn');


        // --- THEME FUNCTIONS ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                darkModeToggleBtn.innerHTML = `<i data-lucide="moon" class="w-6 h-6 text-blue-400"></i>`;
                if(document.getElementById('calculatorHost')) { 
                    document.getElementById('calculatorHost').style.backgroundColor = '#1e293b'; 
                    document.getElementById('calculatorHost').style.color = '#e2e8f0'; 
                }
            } else {
                document.documentElement.classList.remove('dark');
                darkModeToggleBtn.innerHTML = `<i data-lucide="sun" class="w-6 h-6 text-yellow-500"></i>`;
                 if(document.getElementById('calculatorHost')) { 
                    document.getElementById('calculatorHost').style.backgroundColor = '#f0f4f8';
                    document.getElementById('calculatorHost').style.color = '#333'; 
                }
            }
            currentTheme = theme; 
            localStorage.setItem('diabetesAppTheme', theme);
            lucide.createIcons();
            updateChartColors(theme);
        }

        function updateChartColors(theme) {
            const isDark = theme === 'dark';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const textColor = isDark ? '#cbd5e1' : '#4b5563'; 

            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;
            
            if (dayGlucoseChartInstance) {
                const ds = dayGlucoseChartInstance.data.datasets[0];
                ds.borderColor = isDark ? '#f87171' : '#ef4444'; 
                ds.pointBackgroundColor = isDark ? '#f87171' : '#ef4444';
                dayGlucoseChartInstance.update('none'); 
            }
            if (weekGlucoseChartInstance) {
                const ds = weekGlucoseChartInstance.data.datasets[0];
                ds.borderColor = isDark ? '#f87171' : '#ef4444';
                ds.backgroundColor = isDark ? 'rgba(248, 113, 113, 0.3)' : '#fecaca'; 
                weekGlucoseChartInstance.update('none');
            }
            if (carbsInsulinChartInstance) {
                carbsInsulinChartInstance.data.datasets[0].backgroundColor = isDark ? '#60a5fa' : '#3b82f6'; 
                carbsInsulinChartInstance.data.datasets[1].backgroundColor = isDark ? '#34d399' : '#10b981'; 
                carbsInsulinChartInstance.update('none');
            }
            if (activityChartInstance) {
                activityChartInstance.data.datasets[0].backgroundColor = isDark ? '#fbbf24' : '#f59e0b'; 
                activityChartInstance.data.datasets[1].backgroundColor = isDark ? '#f87171' : '#ef4444'; 
                activityChartInstance.update('none');
            }
            if (monthGlucoseChartInstance) {
                const ds = monthGlucoseChartInstance.data.datasets[0];
                ds.borderColor = isDark ? '#f87171' : '#ef4444';
                ds.backgroundColor = isDark ? 'rgba(248, 113, 113, 0.3)' : '#fecaca';
                monthGlucoseChartInstance.update('none');
            }
            if (monthCarbsInsulinChartInstance) {
                monthCarbsInsulinChartInstance.data.datasets[0].backgroundColor = isDark ? '#60a5fa' : '#3b82f6';
                monthCarbsInsulinChartInstance.data.datasets[1].backgroundColor = isDark ? '#34d399' : '#10b981';
                monthCarbsInsulinChartInstance.update('none');
            }
            if (monthActivityChartInstance) {
                monthActivityChartInstance.data.datasets[0].backgroundColor = isDark ? '#fbbf24' : '#f59e0b';
                monthActivityChartInstance.data.datasets[1].backgroundColor = isDark ? '#f87171' : '#ef4444';
                monthActivityChartInstance.update('none');
            }
        }

        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
        }


        // --- UTILITY FUNCTIONS ---
        function saveData() {
            localStorage.setItem('diabetesAppProducts', JSON.stringify(products));
            localStorage.setItem('diabetesAppMeals', JSON.stringify(meals));
            localStorage.setItem('diabetesAppGlucoseRecords', JSON.stringify(glucoseRecords));
        }

        function getDayMeals(date) {
            return meals[date] || [];
        }

        function getDayGlucose(date) {
            return glucoseRecords[date] || [];
        }
        
        function calculateMealStats(mealProducts) {
            let totalCarbs = 0;
            let totalInsulin = 0; 

            mealProducts.forEach(item => {
                const productDetails = products.find(p => p.id === item.id);
                if (!productDetails) return;

                const carbsPer100g = productDetails.carbs;
                const actualCarbs = (carbsPer100g * item.amount) / 100;
                const breadUnits = actualCarbs / 12; 
                
                totalCarbs += actualCarbs;
                totalInsulin += breadUnits * productDetails.insulinRatio;
            });

            return {
                carbs: totalCarbs.toFixed(1),
                breadUnits: (totalCarbs / 12).toFixed(1),
                insulin: totalInsulin.toFixed(1)
            };
        }

        function getGlucoseColor(glucose) { 
            const isDark = currentTheme === 'dark';
            if (glucose < 4) return isDark ? 'text-blue-400' : 'text-blue-600';
            if (glucose <= 7) return isDark ? 'text-green-400' : 'text-green-600';
            if (glucose <= 10) return isDark ? 'text-yellow-400' : 'text-yellow-500'; 
            return isDark ? 'text-red-400' : 'text-red-600';
        }

        function getGlucoseTypeLabel(type) {
            switch (type) {
                case 'before': return 'До еды';
                case 'after': return 'После еды';
                case 'random': return 'Произвольно';
                default: return type;
            }
        }
        
        // Corrected formatDate function (relies on dateString being local YYYY-MM-DD)
        function formatDate(dateString) { 
            if (!dateString) return '';
            const parts = dateString.split('-');
            if (parts.length !== 3) return dateString;

            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; 
            const day = parseInt(parts[2], 10);
            
            const localDate = new Date(year, month, day); // Creates date at 00:00:00 local time
            
            return localDate.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // --- PREDICTION LOGIC (NEW) ---
        function calculateSugarPredictionLogic(currentSugar, carbs, insulinDose, carbRatio, sensitivityFactor, mealType = 'balanced', activityLevel = 'none') {
            if (currentSugar === null || isNaN(carbs) || isNaN(insulinDose) || !carbRatio || !sensitivityFactor) {
                return null;
            }
            
            let carbAbsorptionFactor = 1.0;
            switch (mealType) {
                case 'fast': carbAbsorptionFactor = 1.1; break;
                case 'balanced': carbAbsorptionFactor = 1.0; break;
                case 'slow': carbAbsorptionFactor = 0.80; break;
            }

            let activityEffectOnSugar = 0;
            switch (activityLevel) {
                case 'none': activityEffectOnSugar = 0; break;
                case 'light': activityEffectOnSugar = -0.8; break;
                case 'moderate': activityEffectOnSugar = -2.0; break;
            }

            const sugarIncreaseFromCarbs = ((carbs * carbAbsorptionFactor) / 10) * carbRatio * sensitivityFactor;
            const sugarDecreaseFromActualInsulin = insulinDose * sensitivityFactor;

            let predictedSugar = currentSugar + sugarIncreaseFromCarbs - sugarDecreaseFromActualInsulin + activityEffectOnSugar;

            if (predictedSugar < 0.5) predictedSugar = 0.5;
            if (predictedSugar > 40.0) predictedSugar = 40.0;

            return predictedSugar;
        }

        function findSugarBeforeMeal(dateStr, mealTimeStr) { // dateStr is local YYYY-MM-DD
            const dayGlucose = getDayGlucose(dateStr)
                .filter(r => r.time < mealTimeStr)
                .sort((a, b) => b.time.localeCompare(a.time)); 
            
            if (dayGlucose.length > 0) {
                const latestGlucoseBeforeMeal = dayGlucose[0];
                const mealDateTime = new Date(`${dateStr}T${mealTimeStr}`);
                const glucoseDateTime = new Date(`${dateStr}T${latestGlucoseBeforeMeal.time}`);
                const diffMinutes = (mealDateTime - glucoseDateTime) / (1000 * 60);

                if (diffMinutes <= 90 && diffMinutes >= 0) { 
                    return latestGlucoseBeforeMeal.glucose;
                }
            }
            return null;
        }

        function isPredictionSuperseded(dateStr, mealTimeStr) { // dateStr is local YYYY-MM-DD
            const dayGlucoseAfterMeal = getDayGlucose(dateStr)
                .filter(r => r.time > mealTimeStr)
                .sort((a, b) => a.time.localeCompare(b.time)); 
            
            if (dayGlucoseAfterMeal.length === 0) return false;

            const mealDateTime = new Date(`${dateStr}T${mealTimeStr}`);
            const firstGlucoseAfterMealTime = new Date(`${dateStr}T${dayGlucoseAfterMeal[0].time}`);
            const currentTime = new Date();
            const predictionWindowEnd = new Date(mealDateTime.getTime() + 4 * 60 * 60 * 1000); 

            if (firstGlucoseAfterMealTime < predictionWindowEnd) {
                if (dateStr === getLocalDateYYYYMMDD(new Date())) { 
                    return firstGlucoseAfterMealTime <= currentTime;
                }
                return true; 
            }
            return false;
        }

        function renderPredictedCurrentSugar() {
            if (!predictedSugarSectionEl || !predictedSugarDisplayEl || !predictionContextEl) {
                console.error("Prediction UI elements not found.");
                return;
            }

            predictedSugarSectionEl.style.display = 'none'; 

            const todayLocalStr = getLocalDateYYYYMMDD(new Date());
            if (selectedDate !== todayLocalStr) { // Compare with local 'today'
                return; 
            }

            const dayMealsData = getDayMeals(selectedDate).sort((a, b) => b.time.localeCompare(a.time)); 
            if (dayMealsData.length === 0) {
                return; 
            }
            const latestMeal = dayMealsData[0];

            const mealDateTime = new Date(`${selectedDate}T${latestMeal.time}`); // selectedDate is local YYYY-MM-DD
            const currentTime = new Date();
            const hoursSinceMeal = (currentTime - mealDateTime) / (1000 * 60 * 60);

            if (hoursSinceMeal < 0 || hoursSinceMeal > 4) { 
                return;
            }
            
            if (isPredictionSuperseded(selectedDate, latestMeal.time)) {
                return; 
            }

            const sugarBeforeMeal = findSugarBeforeMeal(selectedDate, latestMeal.time);
            if (sugarBeforeMeal === null) {
                predictionContextEl.textContent = `Для прогноза нужно измерение сахара не более чем за 1.5ч до еды (${latestMeal.time}).`;
                predictedSugarDisplayEl.textContent = '---';
                predictedSugarSectionEl.style.display = 'block';
                lucide.createIcons();
                return;
            }

            const mealStats = calculateMealStats(latestMeal.products);
            const totalCarbs = parseFloat(mealStats.carbs);
            const actualInsulin = latestMeal.actualInsulin || 0; 

            const carbRatio = parseFloat(localStorage.getItem(CR_KEY));
            const sensitivityFactor = parseFloat(localStorage.getItem(SF_KEY));

            if (isNaN(carbRatio) || isNaN(sensitivityFactor)) {
                predictionContextEl.textContent = "Коэффициенты УК и ФЧИ не настроены в Калькуляторе.";
                predictedSugarDisplayEl.textContent = '---';
                predictedSugarSectionEl.style.display = 'block';
                lucide.createIcons();
                return;
            }
            
            const predictedSugar = calculateSugarPredictionLogic(sugarBeforeMeal, totalCarbs, actualInsulin, carbRatio, sensitivityFactor);

            if (predictedSugar !== null) {
                predictedSugarDisplayEl.innerHTML = `<span class="${getGlucoseColor(predictedSugar)}">${predictedSugar.toFixed(1)} ммоль/л</span> <span class="text-base font-normal text-gray-500 dark:text-gray-400">(прогноз)</span>`;
                const predictionValidUntil = new Date(mealDateTime.getTime() + 3 * 60 * 60 * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                predictionContextEl.textContent = `На основе: ${latestMeal.time} (до: ${sugarBeforeMeal} ммоль/л, ${totalCarbs.toFixed(0)}г У, ${actualInsulin.toFixed(1)} ед И). Актуально до ~${predictionValidUntil}.`;
                predictedSugarSectionEl.style.display = 'block';
            } else {
                predictionContextEl.textContent = "Недостаточно данных для прогноза.";
                predictedSugarDisplayEl.textContent = '---';
                predictedSugarSectionEl.style.display = 'block';
            }
            lucide.createIcons();
        }


        // --- RENDER FUNCTIONS ---

        function renderNavigation() {
            document.querySelectorAll('.nav-button').forEach(button => {
                const isActive = button.dataset.view === currentView;
                button.classList.remove(
                    'bg-blue-500', 'text-white', 'dark:bg-blue-600',
                    'bg-gray-100', 'text-gray-700', 'hover:bg-gray-200',
                    'dark:bg-slate-700', 'dark:text-gray-300', 'dark:hover:bg-slate-600'
                );
                if (isActive) {
                    button.classList.add('text-blue-500', 'dark:text-blue-400');
                } else {
                    button.classList.add(
                        'text-gray-600', 'hover:text-gray-800',
                        'dark:text-gray-400', 'dark:hover:text-gray-200'
                    );
                }
            });
        }

        function renderView() {
            viewContents.forEach(view => view.style.display = 'none');
            const currentViewEl = document.getElementById(`${currentView}View`);
            if (currentViewEl) {
                 currentViewEl.style.display = (currentView === 'calendar' || currentView === 'analytics') ? 'grid' : 'block';
                 if (currentView === 'calculator') { 
                     currentViewEl.style.display = 'block'; 
                     if (typeof loadSettingsToCalcForm === 'function') {
                         loadSettingsToCalcForm(); 
                     }
                 }
            }

            renderNavigation();

            switch (currentView) {
                case 'calendar':
                    renderCalendarView();
                    break;
                case 'analytics':
                    renderAnalyticsView();
                    break;
                case 'reports':
                    renderReportsView();
                    break;
                case 'products':
                    renderProductsView();
                    break;
                case 'calculator':
                    // Already handled above
                    break; 
            }
            lucide.createIcons(); 
        }

        function generateCalendarDays() {
            const today = new Date(); 
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; 

            const days = [];
            for (let i = 0; i < startDay; i++) days.push(null);
            for (let day = 1; day <= daysInMonth; day++) {
                const localDayDate = new Date(currentYear, currentMonth, day);
                const localDateString = getLocalDateYYYYMMDD(localDayDate); // Use local YYYY-MM-DD
                days.push({ date: localDateString, day });
            }
            return days;
        }

        function renderCalendarGrid() {
            const today = new Date();
            calendarHeaderEl.textContent = `${monthNames[today.getMonth()]} ${today.getFullYear()}`;
            
            const dayNamesContainer = calendarGridEl.previousElementSibling;
            if (dayNamesContainer.children.length === 0) {
                 ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'].forEach(day => {
                    const div = document.createElement('div');
                    div.className = "text-center text-sm font-medium text-gray-500 dark:text-gray-400 p-2";
                    div.textContent = day;
                    dayNamesContainer.appendChild(div);
                });
            }

            calendarGridEl.innerHTML = '';
            const days = generateCalendarDays();
            days.forEach(dayObj => {
                const dayDiv = document.createElement('div');
                dayDiv.className = "aspect-square";
                if (dayObj) {
                    const button = document.createElement('button');
                    let baseClasses = `w-full h-full rounded-lg flex flex-col items-center justify-center text-sm transition-colors`;
                    
                    let stateClasses = 'hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-slate-700'; 
                    if (selectedDate === dayObj.date) { // dayObj.date is now local YYYY-MM-DD
                        stateClasses = 'bg-blue-500 text-white dark:bg-blue-600 dark:text-white';
                    } else if ((meals[dayObj.date]?.length > 0 || glucoseRecords[dayObj.date]?.length > 0)) {
                        stateClasses = 'bg-green-100 text-green-800 hover:bg-green-200 dark:bg-green-800/80 dark:text-green-300 dark:hover:bg-green-700/80';
                    }
                    button.className = `${baseClasses} ${stateClasses}`;
                    
                    button.innerHTML = `
                        <span>${dayObj.day}</span>
                        <div class="flex gap-1 mt-1">
                            ${meals[dayObj.date]?.length > 0 ? '<div class="w-1.5 h-1.5 bg-orange-500 rounded-full"></div>' : ''}
                            ${glucoseRecords[dayObj.date]?.length > 0 ? '<div class="w-1.5 h-1.5 bg-red-500 rounded-full"></div>' : ''}
                        </div>
                    `;
                    button.onclick = () => {
                        selectedDate = dayObj.date; // Set selectedDate to local YYYY-MM-DD
                        renderCalendarView(); 
                    };
                    dayDiv.appendChild(button);
                }
                calendarGridEl.appendChild(dayDiv);
            });
        }

        function renderDayMeals() {
            mealsHeaderEl.textContent = `Питание ${formatDate(selectedDate)}`; // selectedDate is local YYYY-MM-DD
            dayMealsContainerEl.innerHTML = '';
            const dayMealsData = getDayMeals(selectedDate).sort((a, b) => b.time.localeCompare(a.time)); 

            if (dayMealsData.length === 0) {
                dayMealsContainerEl.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        <i data-lucide="utensils" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <p>Нет записей о питании</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            dayMealsData.forEach(meal => {
                const stats = calculateMealStats(meal.products);
                const mealEl = document.createElement('div');
                mealEl.className = "border rounded-lg p-4 dark:border-slate-700";
                mealEl.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center">
                            <i data-lucide="utensils" class="w-5 h-5 mr-2 text-blue-500 dark:text-blue-400"></i>
                            <span class="font-medium dark:text-gray-200">${meal.time}</span>
                        </div>
                        <button data-meal-id="${meal.id}" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-500">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="space-y-1 mb-3">
                        ${meal.products.map(p => {
                            const productInfo = products.find(prod => prod.id === p.id);
                            return `<div class="text-sm text-gray-600 dark:text-gray-400">${productInfo ? productInfo.name : 'Неизвестный продукт'} - ${p.amount}г</div>`;
                        }).join('')}
                    </div>
                    <div class="bg-gray-50 rounded p-3 text-sm dark:bg-slate-700">
                        <div class="grid grid-cols-2 gap-4 mb-2">
                            <div><span class="text-gray-500 dark:text-gray-400">Углеводы:</span><div class="font-semibold dark:text-gray-200">${stats.carbs}г</div></div>
                            <div><span class="text-gray-500 dark:text-gray-400">ХЕ:</span><div class="font-semibold dark:text-gray-200">${stats.breadUnits}</div></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><span class="text-gray-500 dark:text-gray-400">Расчет инсулина:</span><div class="font-semibold text-blue-600 dark:text-blue-400">${stats.insulin} ед</div></div>
                            <div><span class="text-gray-500 dark:text-gray-400">Фактически:</span><div class="font-semibold text-green-600 dark:text-green-400">${meal.actualInsulin || 0} ед</div></div>
                        </div>
                        ${meal.notes ? `<div class="mt-2 text-xs text-gray-600 dark:text-gray-300"><strong>Заметки:</strong> ${meal.notes}</div>` : ''}
                    </div>
                `;
                mealEl.querySelector('button[data-meal-id]').addEventListener('click', () => deleteMeal(meal.id));
                dayMealsContainerEl.appendChild(mealEl);
            });
            lucide.createIcons();
        }
        
        function renderDayGlucose() {
            glucoseHeaderEl.textContent = `Глюкоза ${formatDate(selectedDate)}`; // selectedDate is local YYYY-MM-DD
            dayGlucoseContainerEl.innerHTML = '';
            const dayGlucoseData = getDayGlucose(selectedDate).sort((a, b) => b.time.localeCompare(a.time));

            if (dayGlucoseData.length === 0) {
                dayGlucoseContainerEl.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        <i data-lucide="activity" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <p>Нет измерений глюкозы</p>
                    </div>`;
                dayGlucoseChartContainerEl.style.display = 'none';
                if (dayGlucoseChartInstance) dayGlucoseChartInstance.destroy();
                lucide.createIcons();
                return;
            }

            dayGlucoseData.forEach(record => {
                const recordEl = document.createElement('div');
                recordEl.className = "border rounded-lg p-3 dark:border-slate-700";
                recordEl.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center">
                            <i data-lucide="droplets" class="w-4 h-4 mr-2 text-red-500 dark:text-red-400"></i>
                            <span class="font-medium dark:text-gray-200">${record.time}</span>
                            <span class="ml-2 text-xs bg-gray-100 px-2 py-1 rounded dark:bg-slate-600 dark:text-gray-300">${getGlucoseTypeLabel(record.type)}</span>
                        </div>
                        <button data-glucose-id="${record.id}" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-500">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="text-2xl font-bold ${getGlucoseColor(record.glucose)}">${record.glucose} ммоль/л</div>
                    ${record.notes ? `<div class="mt-2 text-sm text-gray-600 dark:text-gray-300">${record.notes}</div>` : ''}
                `;
                recordEl.querySelector('button[data-glucose-id]').addEventListener('click', () => deleteGlucose(record.id));
                dayGlucoseContainerEl.appendChild(recordEl);
            });
            lucide.createIcons();
            renderDayGlucoseChart(dayGlucoseData);
        }

        function renderDayGlucoseChart(dayGlucoseData) {
            const chartPoints = dayGlucoseData
                .sort((a, b) => a.time.localeCompare(b.time))
                .map(record => ({ time: record.time, glucose: record.glucose }));

            if (chartPoints.length === 0) {
                dayGlucoseChartContainerEl.style.display = 'none';
                if (dayGlucoseChartInstance) dayGlucoseChartInstance.destroy();
                return;
            }
            dayGlucoseChartContainerEl.style.display = 'block';

            const ctx = document.getElementById('dayGlucoseChartCanvas').getContext('2d');
            if (dayGlucoseChartInstance) dayGlucoseChartInstance.destroy();
            
            const isDark = currentTheme === 'dark';
            dayGlucoseChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartPoints.map(d => d.time),
                    datasets: [{
                        label: 'Глюкоза',
                        data: chartPoints.map(d => d.glucose),
                        borderColor: isDark ? '#f87171' : '#ef4444', 
                        backgroundColor: 'transparent',
                        tension: 0.1,
                        pointBackgroundColor: isDark ? '#f87171' : '#ef4444',
                        pointRadius: 4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, min: 3, max: 15, ticks: { font: { size: 10 }}}, 
                        x: { ticks: { font: { size: 10 }}} 
                    },
                    plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }
                }
            });
        }

        function renderCalendarView() {
            renderCalendarGrid();
            renderDayMeals();
            renderDayGlucose();
            renderPredictedCurrentSugar();
            renderDaySummary(); 
            lucide.createIcons(); 
        }

        function renderDaySummary() {
            const dayMealsData = getDayMeals(selectedDate);
            const dayGlucoseData = getDayGlucose(selectedDate);
            
            let totalCarbs = 0;
            let totalInsulin = 0;
            
            dayMealsData.forEach(meal => {
                const stats = calculateMealStats(meal.products);
                totalCarbs += parseFloat(stats.carbs);
                totalInsulin += meal.actualInsulin || parseFloat(stats.insulin) || 0;
            });
            
            let avgGlucose = 0;
            if (dayGlucoseData.length > 0) {
                avgGlucose = dayGlucoseData.reduce((sum, record) => sum + record.glucose, 0) / dayGlucoseData.length;
            }
            
            document.getElementById('dayTotalCarbs').textContent = `${Math.round(totalCarbs)}г`;
            document.getElementById('dayTotalInsulin').textContent = `${Math.round(totalInsulin * 10) / 10} ед`;
            document.getElementById('dayAvgGlucose').textContent = avgGlucose > 0 ? `${Math.round(avgGlucose * 10) / 10}` : '-';
            document.getElementById('dayMealsCount').textContent = dayMealsData.length;
        }

        // --- Products View Functions ---
        function renderProductsView() {
            productsTableBodyEl.innerHTML = '';
            products.forEach(product => {
                const row = productsTableBodyEl.insertRow();
                row.className = "dark:border-slate-600"
                row.innerHTML = `
                    <td class="border p-3 dark:border-slate-600">${product.name}</td>
                    <td class="border p-3 dark:border-slate-600">${product.carbs}</td>
                    <td class="border p-3 dark:border-slate-600">${product.insulinRatio}</td>
                    <td class="border p-3 dark:border-slate-600">
                        <div class="flex space-x-2">
                            <button data-edit-id="${product.id}" class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-500"><i data-lucide="edit" class="w-4 h-4"></i></button>
                            <button data-delete-id="${product.id}" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </td>
                `;
                row.querySelector(`button[data-edit-id="${product.id}"]`).addEventListener('click', () => openEditProductModal(product.id));
                row.querySelector(`button[data-delete-id="${product.id}"]`).addEventListener('click', () => deleteProduct(product.id));
            });
            lucide.createIcons();
        }

        // --- Analytics and Reports Data Helpers ---
        function getWeekData() {
            const data = [];
            const today = new Date(); // Local 'today'
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i); // Calculate past local dates
                const dateStr = getLocalDateYYYYMMDD(date); // Use local YYYY-MM-DD
                
                const dayMealsData = getDayMeals(dateStr);
                const dayGlucoseData = getDayGlucose(dateStr);
                
                let totalCarbs = 0;
                let totalInsulin = 0;
                
                dayMealsData.forEach(meal => {
                    const stats = calculateMealStats(meal.products);
                    totalCarbs += parseFloat(stats.carbs);
                    totalInsulin += meal.actualInsulin || parseFloat(stats.insulin) || 0;
                });
                
                let avgGlucose = 0;
                if (dayGlucoseData.length > 0) {
                    avgGlucose = dayGlucoseData.reduce((sum, record) => sum + record.glucose, 0) / dayGlucoseData.length;
                }
                
                data.push({
                    date: formatDate(dateStr).substring(0,5), // dd.mm for labels
                    fullDate: dateStr, // local YYYY-MM-DD
                    carbs: Math.round(totalCarbs),
                    insulin: Math.round(totalInsulin * 10) / 10,
                    glucose: avgGlucose > 0 ? Math.round(avgGlucose * 10) / 10 : 0,
                    mealsCount: dayMealsData.length,
                    glucoseCount: dayGlucoseData.length
                });
            }
            return data;
        }
        
        function getMonthData() {
            const data = [];
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth(); // 0-indexed
            const daysInCurrentMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            for (let dayOfMonth = 1; dayOfMonth <= daysInCurrentMonth; dayOfMonth++) {
                const date = new Date(currentYear, currentMonth, dayOfMonth);
                const dateStr = getLocalDateYYYYMMDD(date); // Local YYYY-MM-DD string
                
                const dayMealsData = getDayMeals(dateStr);
                const dayGlucoseData = getDayGlucose(dateStr);
                
                let totalCarbs = 0;
                let totalInsulin = 0;
                
                dayMealsData.forEach(meal => {
                    const stats = calculateMealStats(meal.products);
                    totalCarbs += parseFloat(stats.carbs);
                    totalInsulin += meal.actualInsulin || parseFloat(stats.insulin) || 0;
                });
                
                let avgGlucose = 0;
                if (dayGlucoseData.length > 0) {
                    avgGlucose = dayGlucoseData.reduce((sum, record) => sum + record.glucose, 0) / dayGlucoseData.length;
                }
                
                data.push({
                    date: date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' }), // dd.mm for chart labels
                    fullDate: dateStr, // local YYYY-MM-DD for data keys
                    carbs: Math.round(totalCarbs),
                    insulin: Math.round(totalInsulin * 10) / 10,
                    glucose: avgGlucose > 0 ? Math.round(avgGlucose * 10) / 10 : 0,
                    mealsCount: dayMealsData.length,
                    glucoseCount: dayGlucoseData.length
                });
            }
            return data;
        }


        // --- Analytics View Functions ---
        function renderAnalyticsView() {
            const weekData = getWeekData();
            const monthData = getMonthData();
            const isDark = currentTheme === 'dark';

            // Недельные графики
            const weekGlucoseCtx = document.getElementById('weekGlucoseChartCanvas').getContext('2d');
            if (weekGlucoseChartInstance) weekGlucoseChartInstance.destroy();
            weekGlucoseChartInstance = new Chart(weekGlucoseCtx, {
                type: 'line', 
                data: {
                    labels: weekData.map(d => d.date),
                    datasets: [{
                        label: 'Средняя глюкоза',
                        data: weekData.map(d => d.glucose > 0 ? d.glucose : null), 
                        borderColor: isDark ? '#f87171' : '#ef4444', 
                        backgroundColor: isDark ? 'rgba(248, 113, 113, 0.3)' : '#fecaca', 
                        fill: true,
                        tension: 0.1,
                        borderWidth: 2
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, min: 3, max: 15 } }, plugins: { tooltip: {callbacks: {label: (ctx) => `${ctx.raw} ммоль/л`}} }}
            });

            const carbsInsulinCtx = document.getElementById('carbsInsulinChartCanvas').getContext('2d');
            if (carbsInsulinChartInstance) carbsInsulinChartInstance.destroy();
            carbsInsulinChartInstance = new Chart(carbsInsulinCtx, {
                type: 'bar',
                data: {
                    labels: weekData.map(d => d.date),
                    datasets: [
                        { label: 'Углеводы (г)', data: weekData.map(d => d.carbs), backgroundColor: isDark ? '#60a5fa' : '#3b82f6' }, 
                        { label: 'Инсулин (ед)', data: weekData.map(d => d.insulin), backgroundColor: isDark ? '#34d399' : '#10b981' } 
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
            
            const activityCtx = document.getElementById('activityChartCanvas').getContext('2d');
            if (activityChartInstance) activityChartInstance.destroy();
            activityChartInstance = new Chart(activityCtx, {
                type: 'bar',
                data: {
                    labels: weekData.map(d => d.date),
                    datasets: [
                        { label: 'Приемы пищи', data: weekData.map(d => d.mealsCount), backgroundColor: isDark ? '#fbbf24' : '#f59e0b' }, 
                        { label: 'Измерения глюкозы', data: weekData.map(d => d.glucoseCount), backgroundColor: isDark ? '#f87171' : '#ef4444' } 
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });

            // Месячные графики
            const monthGlucoseCtx = document.getElementById('monthGlucoseChartCanvas').getContext('2d');
            if (monthGlucoseChartInstance) monthGlucoseChartInstance.destroy();
            monthGlucoseChartInstance = new Chart(monthGlucoseCtx, {
                type: 'line', 
                data: {
                    labels: monthData.map(d => d.date),
                    datasets: [{
                        label: 'Средняя глюкоза',
                        data: monthData.map(d => d.glucose > 0 ? d.glucose : null), 
                        borderColor: isDark ? '#f87171' : '#ef4444', 
                        backgroundColor: isDark ? 'rgba(248, 113, 113, 0.3)' : '#fecaca', 
                        fill: true,
                        tension: 0.1,
                        borderWidth: 2
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { beginAtZero: false, min: 3, max: 15 },
                        x: { ticks: { maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 15 } } 
                    }, 
                    plugins: { tooltip: {callbacks: {label: (ctx) => `${ctx.raw} ммоль/л`}} }
                }
            });

            const monthCarbsInsulinCtx = document.getElementById('monthCarbsInsulinChartCanvas').getContext('2d');
            if (monthCarbsInsulinChartInstance) monthCarbsInsulinChartInstance.destroy();
            monthCarbsInsulinChartInstance = new Chart(monthCarbsInsulinCtx, {
                type: 'bar',
                data: {
                    labels: monthData.map(d => d.date),
                    datasets: [
                        { label: 'Углеводы (г)', data: monthData.map(d => d.carbs), backgroundColor: isDark ? '#60a5fa' : '#3b82f6' }, 
                        { label: 'Инсулин (ед)', data: monthData.map(d => d.insulin), backgroundColor: isDark ? '#34d399' : '#10b981' } 
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { beginAtZero: true },
                        x: { ticks: { maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 15 } } 
                    }
                }
            });
            
            const monthActivityCtx = document.getElementById('monthActivityChartCanvas').getContext('2d');
            if (monthActivityChartInstance) monthActivityChartInstance.destroy();
            monthActivityChartInstance = new Chart(monthActivityCtx, {
                type: 'bar',
                data: {
                    labels: monthData.map(d => d.date),
                    datasets: [
                        { label: 'Приемы пищи', data: monthData.map(d => d.mealsCount), backgroundColor: isDark ? '#fbbf24' : '#f59e0b' }, 
                        { label: 'Измерения глюкозы', data: monthData.map(d => d.glucoseCount), backgroundColor: isDark ? '#f87171' : '#ef4444' } 
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { beginAtZero: true, ticks: { stepSize: 1 } },
                        x: { ticks: { maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 15 } }
                    }
                }
            });
            updateChartColors(currentTheme); 

            // Недельная сводка
            const weekSummaryContainer = document.getElementById('weekSummaryContainer');
            const totalCarbs = weekData.reduce((sum, day) => sum + day.carbs, 0);
            const totalInsulin = Math.round(weekData.reduce((sum, day) => sum + day.insulin, 0) * 10) / 10;
            const validGlucoseDays = weekData.filter(d => d.glucose > 0);
            const avgGlucoseWeek = validGlucoseDays.length > 0 ? Math.round(validGlucoseDays.reduce((sum, day) => sum + day.glucose, 0) / validGlucoseDays.length * 10) / 10 : 0;
            const totalMealsWeek = weekData.reduce((sum, day) => sum + day.mealsCount, 0);

            weekSummaryContainer.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 rounded-lg p-4 dark:bg-slate-700">
                        <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">${totalCarbs}г</div>
                        <div class="text-sm text-blue-600 dark:text-blue-400">Общие углеводы</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 dark:bg-slate-700">
                        <div class="text-2xl font-bold text-green-600 dark:text-green-400">${totalInsulin} ед</div>
                        <div class="text-sm text-green-600 dark:text-green-400">Общий инсулин</div>
                    </div>
                    <div class="bg-red-50 rounded-lg p-4 dark:bg-slate-700">
                        <div class="text-2xl font-bold text-red-600 dark:text-red-400">${avgGlucoseWeek || 0}</div>
                        <div class="text-sm text-red-600 dark:text-red-400">Средняя глюкоза</div>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-4 dark:bg-slate-700">
                        <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">${totalMealsWeek}</div>
                        <div class="text-sm text-yellow-600 dark:text-yellow-400">Всего приемов пищи</div>
                    </div>
                </div>
            `;

            // Месячная сводка
            const monthSummaryContainer = document.getElementById('monthSummaryContainer');
            const monthTotalCarbs = monthData.reduce((sum, day) => sum + day.carbs, 0);
            const monthTotalInsulin = Math.round(monthData.reduce((sum, day) => sum + day.insulin, 0) * 10) / 10;
            const monthValidGlucoseDays = monthData.filter(d => d.glucose > 0);
            const monthAvgGlucose = monthValidGlucoseDays.length > 0 ? Math.round(monthValidGlucoseDays.reduce((sum, day) => sum + day.glucose, 0) / monthValidGlucoseDays.length * 10) / 10 : 0;
            const monthTotalMeals = monthData.reduce((sum, day) => sum + day.mealsCount, 0);

            monthSummaryContainer.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 rounded-lg p-4 dark:bg-slate-700">
                        <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">${monthTotalCarbs}г</div>
                        <div class="text-sm text-blue-600 dark:text-blue-400">Общие углеводы</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 dark:bg-slate-700">
                        <div class="text-2xl font-bold text-green-600 dark:text-green-400">${monthTotalInsulin} ед</div>
                        <div class="text-sm text-green-600 dark:text-green-400">Общий инсулин</div>
                    </div>
                    <div class="bg-red-50 rounded-lg p-4 dark:bg-slate-700">
                        <div class="text-2xl font-bold text-red-600 dark:text-red-400">${monthAvgGlucose || 0}</div>
                        <div class="text-sm text-red-600 dark:text-red-400">Средняя глюкоза</div>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-4 dark:bg-slate-700">
                        <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">${monthTotalMeals}</div>
                        <div class="text-sm text-yellow-600 dark:text-yellow-400">Всего приемов пищи</div>
                    </div>
                </div>
            `;
        }
        
        // --- Reports View Functions ---
        function renderReportsView() {
            const weekData = getWeekData();
            const reportTableBody = document.getElementById('weekReportTableBody');
            reportTableBody.innerHTML = '';
            weekData.forEach(day => {
                const row = reportTableBody.insertRow();
                row.className = "dark:border-slate-600"
                row.innerHTML = `
                    <td class="border p-3 dark:border-slate-600">${formatDate(day.fullDate)}</td>
                    <td class="border p-3 dark:border-slate-600">${day.mealsCount}</td>
                    <td class="border p-3 dark:border-slate-600">${day.carbs}г</td>
                    <td class="border p-3 dark:border-slate-600">${day.insulin} ед</td>
                    <td class="border p-3 dark:border-slate-600 ${getGlucoseColor(day.glucose)}">${day.glucose > 0 ? `${day.glucose} ммоль/л` : '-'}</td>
                    <td class="border p-3 dark:border-slate-600">${day.glucoseCount}</td>
                `;
            });

            const analysisContainer = document.getElementById('glucoseControlAnalysisContainer');
            const allGlucose = weekData.filter(d => d.glucose > 0).map(d => d.glucose);
            const inRange = allGlucose.filter(g => g >= 4 && g <= 7).length;
            const totalMeasurements = allGlucose.length;
            const percentageInRange = totalMeasurements > 0 ? Math.round((inRange / totalMeasurements) * 100) : 0;
            analysisContainer.innerHTML = `
                <h3 class="text-lg font-semibold mb-4 dark:text-gray-100">Анализ контроля глюкозы</h3>
                <div class="space-y-3">
                    <div class="flex justify-between dark:text-gray-300">
                        <span>В целевом диапазоне (4-7 ммоль/л):</span>
                        <span class="font-semibold">${percentageInRange}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-slate-600">
                        <div class="bg-green-500 h-2 rounded-full dark:bg-green-600" style="width: ${percentageInRange}%"></div>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">${inRange} из ${totalMeasurements} измерений в норме</div>
                </div>
            `;

            const recContainer = document.getElementById('recommendationsContainer');
            recContainer.innerHTML = `<h3 class="text-lg font-semibold mb-4 dark:text-gray-100">Рекомендации</h3><div class="space-y-2 text-sm"></div>`;
            const recListEl = recContainer.querySelector('.space-y-2');
            
            const validGlucoseDaysRec = weekData.filter(d => d.glucose > 0);
            const avgGlucoseRec = validGlucoseDaysRec.length > 0 ? validGlucoseDaysRec.reduce((sum, d) => sum + d.glucose, 0) / validGlucoseDaysRec.length : 0;
            const avgCarbsRec = weekData.reduce((sum, d) => sum + d.carbs, 0) / (weekData.length || 1);
            
            const recommendations = [];
            if (avgGlucoseRec > 8) recommendations.push("⚠️ Средний уровень глюкозы повышен. Проконсультируйтесь с врачом.");
            if (avgCarbsRec > 200) recommendations.push("📊 Высокое потребление углеводов. Рассмотрите снижение порций.");
            if (weekData.some(d => d.mealsCount < 3 && d.mealsCount > 0)) recommendations.push("🍽️ Некоторые дни с малым количеством приемов пищи. Старайтесь питаться регулярно.");
            if (recommendations.length === 0) recommendations.push("✅ Хороший контроль! Продолжайте в том же духе.");
            
            recommendations.forEach(rec => {
                const div = document.createElement('div');
                div.className = "p-2 bg-gray-50 rounded dark:bg-slate-700 dark:text-gray-300";
                div.textContent = rec;
                recListEl.appendChild(div);
            });
        }

        // --- MODAL HANDLING ---
        function openModal(modalElement) { modalElement.classList.add('show'); }
        function closeModal(modalElement) { modalElement.classList.remove('show'); }

        // Add Product Modal
        document.getElementById('showAddProductModalBtn').addEventListener('click', () => {
            editingProductId = null;
            document.getElementById('addProductModalTitle').textContent = 'Добавить продукт';
            document.getElementById('addProductSubmitBtn').textContent = 'Добавить';
            document.getElementById('addProductForm').reset();
            openModal(addProductModalEl);
        });
        document.getElementById('cancelAddProductBtn').addEventListener('click', () => closeModal(addProductModalEl));
        document.getElementById('addProductForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('newProductName').value;
            const carbs = parseFloat(document.getElementById('newProductCarbs').value);
            const insulinRatio = parseFloat(document.getElementById('newProductInsulinRatio').value);

            if (name && !isNaN(carbs) && !isNaN(insulinRatio)) {
                if (editingProductId) {
                    products = products.map(p => p.id === editingProductId ? { id: editingProductId, name, carbs, insulinRatio } : p);
                } else {
                    products.push({ id: Date.now(), name, carbs, insulinRatio });
                }
                saveData();
                if (currentView === 'products') renderProductsView();
                if (currentView === 'calendar') renderNewMealProductOptions(); 
                lucide.createIcons(); 
                closeModal(addProductModalEl);
            } else {
                alert('Пожалуйста, заполните все поля корректно.');
            }
        });

        function openEditProductModal(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                editingProductId = id;
                document.getElementById('addProductModalTitle').textContent = 'Редактировать продукт';
                document.getElementById('addProductSubmitBtn').textContent = 'Сохранить';
                document.getElementById('editingProductId').value = product.id;
                document.getElementById('newProductName').value = product.name;
                document.getElementById('newProductCarbs').value = product.carbs;
                document.getElementById('newProductInsulinRatio').value = product.insulinRatio;
                openModal(addProductModalEl);
            }
        }
        
        function deleteProduct(id) {
            if (confirm('Вы уверены, что хотите удалить этот продукт?')) {
                products = products.filter(p => p.id !== id);
                saveData();
                if (currentView === 'products') renderProductsView();
                if (currentView === 'calendar') renderNewMealProductOptions(); 
                lucide.createIcons();
            }
        }

        // Add Meal Modal
        document.getElementById('showAddMealModalBtn').addEventListener('click', () => {
            newMealFormState.products = [];
            document.getElementById('addMealForm').reset();
            renderNewMealProductOptions();
            renderNewMealProductsList(); 
            openModal(addMealModalEl);
        });
        document.getElementById('cancelAddMealBtn').addEventListener('click', () => closeModal(addMealModalEl));
        
        function renderNewMealProductOptions() {
            const selectEl = document.getElementById('newMealSelectedProduct');
            selectEl.innerHTML = '<option value="">Выберите продукт</option>';
            products.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                selectEl.appendChild(option);
            });
        }

        function renderNewMealProductsList() {
            const listContainer = document.getElementById('newMealProductsList');
            const listContainerWrapper = document.getElementById('newMealProductsListContainer');
            const calculationEl = document.getElementById('newMealCalculation');
            listContainer.innerHTML = '';

            if (newMealFormState.products.length === 0) {
                listContainerWrapper.style.display = 'none';
                calculationEl.style.display = 'none';
                return;
            }
            listContainerWrapper.style.display = 'block';

            newMealFormState.products.forEach((item, index) => {
                const productDetails = products.find(p => p.id === item.id);
                const itemEl = document.createElement('div');
                itemEl.className = "flex justify-between items-center bg-gray-50 p-2 rounded dark:bg-slate-700 dark:text-gray-300";
                itemEl.innerHTML = `
                    <span>${productDetails ? productDetails.name : 'Неизвестный'} - ${item.amount}г</span>
                    <button type="button" data-remove-idx="${index}" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-500">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                itemEl.querySelector('button').addEventListener('click', () => {
                    newMealFormState.products.splice(index, 1);
                    renderNewMealProductsList();
                });
                listContainer.appendChild(itemEl);
            });
            lucide.createIcons();
            
            const stats = calculateMealStats(newMealFormState.products);
            calculationEl.innerHTML = `
                <i data-lucide="calculator" class="w-4 h-4 inline mr-2"></i>
                <strong>Расчет:</strong> ${stats.carbs}г углеводов, ${stats.breadUnits} ХЕ, ${stats.insulin} ед инсулина
            `;
            calculationEl.style.display = 'block';
            lucide.createIcons();
        }

        document.getElementById('addProductToMealBtn').addEventListener('click', () => {
            const productId = parseInt(document.getElementById('newMealSelectedProduct').value);
            const amount = parseFloat(document.getElementById('newMealProductAmount').value);

            if (!productId) { alert('Пожалуйста, выберите продукт'); return; }
            if (isNaN(amount) || amount <= 0) { alert('Пожалуйста, укажите корректный вес продукта'); return; }
            
            const product = products.find(p => p.id === productId);
            if (!product) { alert('Продукт не найден'); return; }

            newMealFormState.products.push({ id: product.id, amount });
            renderNewMealProductsList();
            document.getElementById('newMealSelectedProduct').value = '';
            document.getElementById('newMealProductAmount').value = '';
        });

        document.getElementById('addMealForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const time = document.getElementById('newMealTime').value;
            const actualInsulin = parseFloat(document.getElementById('newMealActualInsulin').value) || 0;
            const notes = document.getElementById('newMealNotes').value;

            if (!time) { alert('Пожалуйста, укажите время приема пищи'); return; }
            if (newMealFormState.products.length === 0) { alert('Пожалуйста, добавьте хотя бы один продукт'); return; }

            const dayMealsData = getDayMeals(selectedDate);
            const newMealEntry = {
                id: Date.now(),
                time,
                products: [...newMealFormState.products], 
                actualInsulin,
                notes
            };
            
            meals[selectedDate] = [...dayMealsData, newMealEntry].sort((a, b) => a.time.localeCompare(b.time));
            saveData();
            if (currentView === 'calendar') renderCalendarView(); 
            else if (currentView === 'analytics' || currentView === 'reports') renderView(); 
            lucide.createIcons();
            closeModal(addMealModalEl);
        });

        function deleteMeal(mealId) {
             if (confirm('Вы уверены, что хотите удалить этот прием пищи?')) {
                const dayMealsData = getDayMeals(selectedDate);
                meals[selectedDate] = dayMealsData.filter(m => m.id !== mealId);
                if (meals[selectedDate].length === 0) delete meals[selectedDate];
                saveData();
                if (currentView === 'calendar') renderCalendarView();
                else if (currentView === 'analytics' || currentView === 'reports') renderView();
                lucide.createIcons();
            }
        }

        // Add Glucose Modal
        document.getElementById('showAddGlucoseModalBtn').addEventListener('click', () => {
            document.getElementById('addGlucoseForm').reset();
            openModal(addGlucoseModalEl);
        });
        document.getElementById('cancelAddGlucoseBtn').addEventListener('click', () => closeModal(addGlucoseModalEl));
        document.getElementById('addGlucoseForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const time = document.getElementById('newGlucoseTime').value;
            const glucoseLevel = parseFloat(document.getElementById('newGlucoseLevel').value);
            const type = document.getElementById('newGlucoseType').value;
            const notes = document.getElementById('newGlucoseNotes').value;

            if (time && !isNaN(glucoseLevel)) {
                const dayGlucoseData = getDayGlucose(selectedDate);
                glucoseRecords[selectedDate] = [
                    ...dayGlucoseData, 
                    { id: Date.now(), time, glucose: glucoseLevel, type, notes }
                ].sort((a, b) => a.time.localeCompare(b.time));
                saveData();
                if (currentView === 'calendar') renderCalendarView();
                else if (currentView === 'analytics' || currentView === 'reports') renderView();
                lucide.createIcons();
                closeModal(addGlucoseModalEl);
            } else {
                alert('Пожалуйста, укажите время и уровень глюкозы.');
            }
        });

        function deleteGlucose(recordId) {
            if (confirm('Вы уверены, что хотите удалить это измерение глюкозы?')) {
                const dayGlucoseData = getDayGlucose(selectedDate);
                glucoseRecords[selectedDate] = dayGlucoseData.filter(r => r.id !== recordId);
                if (glucoseRecords[selectedDate].length === 0) delete glucoseRecords[selectedDate];
                saveData();
                if (currentView === 'calendar') renderCalendarView();
                else if (currentView === 'analytics' || currentView === 'reports') renderView();
                lucide.createIcons();
            }
        }
        
        // --- EVENT LISTENERS ---
        navigationButtons.addEventListener('click', (e) => {
            const button = e.target.closest('.nav-button');
            if (button && button.dataset.view) {
                currentView = button.dataset.view;
                renderView();
            }
        });

        darkModeToggleBtn.addEventListener('click', toggleTheme);
        
        if (correctPredictionBtnEl) {
            correctPredictionBtnEl.addEventListener('click', () => {
                const nowTime = new Date().toTimeString().substring(0,5);
                document.getElementById('addGlucoseForm').reset();
                document.getElementById('newGlucoseTime').value = nowTime;
                document.getElementById('newGlucoseType').value = 'random'; 
                openModal(addGlucoseModalEl);
            });
        }

        // --- EXPORT/IMPORT FUNCTIONALITY ---
        document.getElementById('exportDayDataBtn').addEventListener('click', () => {
            const dayMealsData = getDayMeals(selectedDate);
            const dayGlucoseData = getDayGlucose(selectedDate);

            if (dayMealsData.length === 0 && dayGlucoseData.length === 0) {
                alert('Нет данных для экспорта за выбранный день.');
                return;
            }

            const dataToExport = {
                date: selectedDate, // selectedDate is already local YYYY-MM-DD
                meals: dayMealsData,
                glucoseRecords: dayGlucoseData
            };

            const jsonData = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diary_day_data_${selectedDate}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        document.getElementById('exportAllDataBtn').addEventListener('click', () => {
            const allDataToExport = {
                allData: { 
                    products: products,
                    meals: meals, // meals keys are local YYYY-MM-DD
                    glucoseRecords: glucoseRecords // glucoseRecords keys are local YYYY-MM-DD
                }
            };
            const jsonData = JSON.stringify(allDataToExport, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diary_all_data_${getLocalDateYYYYMMDD(new Date())}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Все данные экспортированы.');
        });

        document.getElementById('importDataBtn').addEventListener('click', () => {
            document.getElementById('importFile').click();
        });

        document.getElementById('importFile').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (importedData && importedData.allData) { 
                            if (confirm("Это приведет к полной замене всех существующих данных. Продолжить?")) {
                                if (importedData.allData.meals) meals = importedData.allData.meals; else meals = {};
                                if (importedData.allData.glucoseRecords) glucoseRecords = importedData.allData.glucoseRecords; else glucoseRecords = {};
                                if (importedData.allData.products) products = importedData.allData.products; else products = [];
                                alert('Все данные импортированы и заменены.');
                            } else {
                                alert('Импорт отменен.');
                                event.target.value = null; 
                                return;
                            }
                        } else if (importedData && importedData.date && (importedData.meals || importedData.glucoseRecords)) { 
                            const dateToImport = importedData.date; // Assume this is local YYYY-MM-DD from export
                            if (importedData.meals) {
                                const existingMeals = meals[dateToImport] || [];
                                const newMeals = importedData.meals.filter(im => !existingMeals.some(em => em.id === im.id)); // Avoid duplicates by ID
                                meals[dateToImport] = [...existingMeals, ...newMeals].sort((a, b) => a.time.localeCompare(b.time));
                            }
                            if (importedData.glucoseRecords) {
                                 const existingGlucose = glucoseRecords[dateToImport] || [];
                                 const newGlucose = importedData.glucoseRecords.filter(ig => !existingGlucose.some(eg => eg.id === ig.id)); // Avoid duplicates by ID
                                glucoseRecords[dateToImport] = [...existingGlucose, ...newGlucose].sort((a, b) => a.time.localeCompare(b.time));
                            }
                            selectedDate = dateToImport; // Switch to the imported day
                            alert(`Данные за ${formatDate(dateToImport)} импортированы и объединены.`);
                        } else {
                            alert('Неверный формат файла. Ожидается JSON с полями "date", "meals", "glucoseRecords" для однодневного импорта, или "allData" для полного импорта.');
                        }
                        saveData();
                        renderView(); 
                        lucide.createIcons();
                    } catch (error) {
                        console.error("Error parsing imported JSON:", error);
                        alert('Ошибка при чтении файла. Убедитесь, что это корректный JSON файл.');
                    }
                    event.target.value = null; 
                };
                reader.readAsText(file);
            }
        });


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(currentTheme); 
            renderView(); 
        });
        // --- END OF DIARY APP JavaScript ---

    </script>
</body>
</html>